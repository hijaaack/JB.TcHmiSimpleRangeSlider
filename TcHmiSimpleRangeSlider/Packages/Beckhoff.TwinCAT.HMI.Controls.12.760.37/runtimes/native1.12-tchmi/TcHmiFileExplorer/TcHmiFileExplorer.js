var TcHmi,__classPrivateFieldGet=this&&this.__classPrivateFieldGet||function(receiver,state,kind,f){if("a"===kind&&!f)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof state?receiver!==state||!f:!state.has(receiver))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===kind?f:"a"===kind?f.call(receiver):f?f.value:state.get(receiver)};!function(TcHmi){!function(Controls){!function(Beckhoff){var _a,_TcHmiFileExplorer_tchmiFQN;class TcHmiFileExplorer extends TcHmi.Controls.System.TcHmiControl{constructor(element,pcElement,attrs){super(element,pcElement,attrs),this.__destroyersToCallOnDetach=[],this.__localizationReader=void 0,this.__destroyLocalizationWatch=null,this.__directory={fileFlags:["Directory"],children:new Map},this.__clipboard=null,this.__subscriptionId=null,this.__symbolAccessSubscriptionId=null,this.__symbolAccess={Upload:TcHmiFileExplorer.SymbolAccess.None,Rename:TcHmiFileExplorer.SymbolAccess.None,Copy:TcHmiFileExplorer.SymbolAccess.None,Delete:TcHmiFileExplorer.SymbolAccess.None,"TcHmiSrv.Config":TcHmiFileExplorer.SymbolAccess.None},this.__fileUploader=null,this.__namePrompt=null,this.__confirmationPrompt=null,this.__errorPrompt=null,this.__showNavigationPane=!1,this.__navigationPanePosition="Left",this.__onPathChanged=(currentItem,path)=>{this.setPath(path?path.join("/"):null)},this.__onSelectionChanged=selectedItems=>{this.__updateButtonsEnabled(),TcHmi.EventProvider.raise(this.__id+".onPropertyChanged",{propertyName:"SelectedItems"}),TcHmi.EventProvider.raise(this.__id+".onSelectionChanged")},this.__onCreateFolderPressed=()=>{this.__root&&this.__path&&this.__createFolder(this.__root.combine(this.__path))},this.__onDownloadPressed=()=>{const items=this.__directoryBrowser.getSelectedItems();items&&this.__root&&this.__path&&this.__downloadFiles(this.__root.combine(this.__path),items)},this.__onUploadPressed=()=>{this.__upload()},this.__onRenamePressed=()=>{const items=this.__directoryBrowser.getSelectedItems();items&&1===items.length&&this.__root&&this.__path&&this.__rename(this.__root.combine(this.__path),items[0].name)},this.__onCopyPressed=()=>{const items=this.__directoryBrowser.getSelectedItems();if(items&&this.__root&&this.__path){const path=this.__root.combine(this.__path);this.__clipboard={action:"copy",items:items.map((item=>path.combine(item.name)))},this.__updateButtonsEnabled(),this.__updateButtonAccess(),this.__buttons.paste.setVirtualControlRightMappings([{controlRight:"operate",virtualControlRight:"create"}])}},this.__onCutPressed=()=>{const items=this.__directoryBrowser.getSelectedItems();if(items&&this.__root&&this.__path){const path=this.__root.combine(this.__path);this.__clipboard={action:"cut",items:items.map((item=>path.combine(item.name)))},this.__updateButtonsEnabled(),this.__updateButtonAccess(),this.__buttons.paste.setVirtualControlRightMappings([{controlRight:"operate",virtualControlRight:"cut"}])}},this.__onPastePressed=()=>{if(this.__root&&this.__path){const existingNames=this.__directoryBrowser.getCurrentFolder()?.children.keys();this.__paste(this.__root.combine(this.__path),new Set(existingNames))}},this.__onDeletePressed=()=>{const items=this.__directoryBrowser.getSelectedItems();items&&this.__root&&this.__path&&this.__delete(this.__root.combine(this.__path),items)}}__previnit(){super.__previnit();const elementTemplateRoot=this.__element[0].querySelector(".TcHmi_Controls_Beckhoff_TcHmiFileExplorer-template"),elementDirectoryTree=elementTemplateRoot?.querySelector(".TcHmi_Controls_Beckhoff_TcHmiFileExplorer-directory-tree"),elementPathBox=elementTemplateRoot?.querySelector(".TcHmi_Controls_Beckhoff_TcHmiFileExplorer-path-box"),elementBrowsingBox=elementTemplateRoot?.querySelector(".TcHmi_Controls_Beckhoff_TcHmiFileExplorer-browsing-box");if(!(elementTemplateRoot&&elementDirectoryTree&&elementPathBox&&elementBrowsingBox))throw new Error("Invalid Template.html");this.__elementTemplateRoot=elementTemplateRoot,this.__elementDirectoryTree=elementDirectoryTree,this.__elementPathBox=elementPathBox,this.__elementBrowsingBox=elementBrowsingBox;const buttonCreateFolder=Controls.get(this.__id+"_ButtonCreateFolder"),buttonDownload=Controls.get(this.__id+"_ButtonDownload"),buttonUpload=Controls.get(this.__id+"_ButtonUpload"),buttonRename=Controls.get(this.__id+"_ButtonRename"),buttonCopy=Controls.get(this.__id+"_ButtonCopy"),buttonCut=Controls.get(this.__id+"_ButtonCut"),buttonPaste=Controls.get(this.__id+"_ButtonPaste"),buttonDelete=Controls.get(this.__id+"_ButtonDelete");if(!(buttonCreateFolder&&buttonDownload&&buttonUpload&&buttonRename&&buttonCopy&&buttonCut&&buttonPaste&&buttonDelete))throw new Error("Controls in Template.html were not instantiated");TcHmi.Environment.getBrowserCapabilities().supportsDownload||TcHmi.Binding.createEx2(this.__expandLocalizationSymbol("Button_Tooltip_Download_NotSupported"),"Tooltip",buttonDownload),this.__buttons={createFolder:buttonCreateFolder,download:buttonDownload,upload:buttonUpload,rename:buttonRename,copy:buttonCopy,cut:buttonCut,paste:buttonPaste,delete:buttonDelete};const createMapping={controlRight:"operate",virtualControlRight:"create"};this.__buttons.createFolder.setVirtualControlRightMappings([createMapping]),this.__buttons.download.setVirtualControlRightMappings([{controlRight:"operate",virtualControlRight:"download"}]),this.__buttons.upload.setVirtualControlRightMappings([createMapping]),this.__buttons.rename.setVirtualControlRightMappings([{controlRight:"operate",virtualControlRight:"rename"}]),this.__buttons.copy.setVirtualControlRightMappings([createMapping]),this.__buttons.cut.setVirtualControlRightMappings([{controlRight:"operate",virtualControlRight:"cut"}]),this.__buttons.paste.setVirtualControlRightMappings([createMapping]),this.__buttons.delete.setVirtualControlRightMappings([{controlRight:"operate",virtualControlRight:"delete"}]);const treeBrowsingDisplay=new Controls.Helpers.ListBrowsingDisplay(this.__elementDirectoryTree,this),pathDisplay=new Controls.Helpers.PathDisplay(this.__elementPathBox,this);this.__listBrowsingDisplay=new Controls.Helpers.ListBrowsingDisplay(this.__elementBrowsingBox,this),this.__directoryBrowser=new Controls.Helpers.DirectoryBrowser([treeBrowsingDisplay,pathDisplay,this.__listBrowsingDisplay]),this.__directoryBrowser.setMultiSelectAllowed(!0),this.__directoryBrowser.setNavigationToFilesAllowed(!1),this.__destroyLocalizationWatch=this.__localization.watch((data=>{data.error===TcHmi.Errors.NONE&&data.reader&&(this.__localizationReader=data.reader,this.__localizeListBrowsingDisplay())}))}__init(){super.__init()}__attach(){super.__attach(),this.__directoryBrowser.resume(),this.__directoryBrowser.onPathChange.add(this.__onPathChanged),this.__directoryBrowser.onSelectionChange.add(this.__onSelectionChanged),this.__destroyersToCallOnDetach.push(TcHmi.EventProvider.register(this.__buttons.createFolder.getId()+".onPressed",this.__onCreateFolderPressed)),this.__destroyersToCallOnDetach.push(TcHmi.EventProvider.register(this.__buttons.download.getId()+".onPressed",this.__onDownloadPressed)),this.__destroyersToCallOnDetach.push(TcHmi.EventProvider.register(this.__buttons.upload.getId()+".onPressed",this.__onUploadPressed)),this.__destroyersToCallOnDetach.push(TcHmi.EventProvider.register(this.__buttons.rename.getId()+".onPressed",this.__onRenamePressed)),this.__destroyersToCallOnDetach.push(TcHmi.EventProvider.register(this.__buttons.copy.getId()+".onPressed",this.__onCopyPressed)),this.__destroyersToCallOnDetach.push(TcHmi.EventProvider.register(this.__buttons.cut.getId()+".onPressed",this.__onCutPressed)),this.__destroyersToCallOnDetach.push(TcHmi.EventProvider.register(this.__buttons.paste.getId()+".onPressed",this.__onPastePressed)),this.__destroyersToCallOnDetach.push(TcHmi.EventProvider.register(this.__buttons.delete.getId()+".onPressed",this.__onDeletePressed)),this.__updateSubscription(),this.__updateSymbolAccessSubscription()}__detach(){super.__detach(),this.__directoryBrowser.suspend(),this.__directoryBrowser.onPathChange.remove(this.__onPathChanged),this.__directoryBrowser.onSelectionChange.remove(this.__onSelectionChanged);for(const destroy of this.__destroyersToCallOnDetach)destroy();this.__destroyersToCallOnDetach=[],this.__updateSubscription(!0),this.__updateSymbolAccessSubscription(!0)}destroy(){this.__keepAlive||(this.__destroyLocalizationWatch?.(),this.__destroyLocalizationWatch=null,super.destroy())}__expandLocalizationSymbol(key){return`%l%Control::${__classPrivateFieldGet(TcHmiFileExplorer,_a,"f",_TcHmiFileExplorer_tchmiFQN)}::${key}%/l%`}__updateButtonsEnabled(){const currentFolder=this.__directoryBrowser.getCurrentFolder(),currentFolderEditable=null!==currentFolder&&!currentFolder.payload.fileFlags.includes("ReadOnly")&&!currentFolder.payload.fileFlags.includes("UserAccessReadOnly"),selectedItems=this.__directoryBrowser.getSelectedItems()??[],onlyVirtualDirectoriesSelected=selectedItems.every((item=>item.payload.fileFlags.includes("VirtualDirectory"))),onlyDirectoriesSelected=selectedItems.every((item=>item.payload.fileFlags.includes("VirtualDirectory")||item.payload.fileFlags.includes("Directory"))),onlyReadOnlySelected=selectedItems.every((item=>item.payload.fileFlags.includes("ReadOnly")||item.payload.fileFlags.includes("UserAccessReadOnly")));this.__buttons.createFolder.setIsEnabled(currentFolderEditable),this.__buttons.download.setIsEnabled(selectedItems.length>0&&!onlyDirectoriesSelected&&TcHmi.Environment.getBrowserCapabilities().supportsDownload),this.__buttons.upload.setIsEnabled(currentFolderEditable),this.__buttons.rename.setIsEnabled(currentFolderEditable&&1===selectedItems.length&&!onlyVirtualDirectoriesSelected&&!onlyReadOnlySelected),this.__buttons.copy.setIsEnabled(selectedItems.length>0),this.__buttons.cut.setIsEnabled(currentFolderEditable&&selectedItems.length>0),this.__buttons.paste.setIsEnabled(currentFolderEditable&&null!==this.__clipboard),this.__buttons.delete.setIsEnabled(currentFolderEditable&&selectedItems.length>0&&!onlyVirtualDirectoriesSelected&&!onlyReadOnlySelected)}__updateButtonAccess(){const canUpload=this.__symbolAccess.Upload>=TcHmiFileExplorer.SymbolAccess.Write,canReadConfig=this.__symbolAccess["TcHmiSrv.Config"]===TcHmiFileExplorer.SymbolAccess.Read||this.__symbolAccess["TcHmiSrv.Config"]===TcHmiFileExplorer.SymbolAccess.ReadWrite,canRename=this.__symbolAccess.Rename>=TcHmiFileExplorer.SymbolAccess.Write,canCopy=this.__symbolAccess.Copy>=TcHmiFileExplorer.SymbolAccess.Write,canDelete=this.__symbolAccess.Delete>=TcHmiFileExplorer.SymbolAccess.Write;TcHmi.Access.setControlRightOverride(this.__buttons.createFolder,"operate",canUpload?null:"Deny"),TcHmi.Binding.createEx2(this.__expandLocalizationSymbol(canUpload?"Button_Tooltip_CreateFolder":"Button_Tooltip_CreateFolder_MissingSymbolAccess"),"Tooltip",this.__buttons.createFolder),TcHmi.Access.setControlRightOverride(this.__buttons.upload,"operate",canUpload&&canReadConfig?null:"Deny"),TcHmi.Binding.createEx2(this.__expandLocalizationSymbol(canUpload&&canReadConfig?"Button_Tooltip_Upload":"Button_Tooltip_Upload_MissingSymbolAccess"),"Tooltip",this.__buttons.upload),TcHmi.Access.setControlRightOverride(this.__buttons.rename,"operate",canRename?null:"Deny"),TcHmi.Binding.createEx2(this.__expandLocalizationSymbol(canRename?"Button_Tooltip_Rename":"Button_Tooltip_Rename_MissingSymbolAccess"),"Tooltip",this.__buttons.rename),TcHmi.Access.setControlRightOverride(this.__buttons.copy,"operate",canCopy?null:"Deny"),TcHmi.Binding.createEx2(this.__expandLocalizationSymbol(canCopy?"Button_Tooltip_Copy":"Button_Tooltip_Copy_MissingSymbolAccess"),"Tooltip",this.__buttons.copy),TcHmi.Access.setControlRightOverride(this.__buttons.cut,"operate",canRename?null:"Deny"),TcHmi.Binding.createEx2(this.__expandLocalizationSymbol(canRename?"Button_Tooltip_Cut":"Button_Tooltip_Cut_MissingSymbolAccess"),"Tooltip",this.__buttons.cut),TcHmi.Access.setControlRightOverride(this.__buttons.paste,"operate",null===this.__clipboard||("copy"===this.__clipboard.action?canCopy:canRename)?null:"Deny"),TcHmi.Binding.createEx2(this.__expandLocalizationSymbol(null===this.__clipboard||("copy"===this.__clipboard.action?canCopy:canRename)?"Button_Tooltip_Paste":"Button_Tooltip_Paste_MissingSymbolAccess"),"Tooltip",this.__buttons.paste),TcHmi.Access.setControlRightOverride(this.__buttons.delete,"operate",canDelete?null:"Deny"),TcHmi.Binding.createEx2(this.__expandLocalizationSymbol(canDelete?"Button_Tooltip_Delete":"Button_Tooltip_Delete_MissingSymbolAccess"),"Tooltip",this.__buttons.delete)}__createNamePrompt(){const prompt=new Controls.Helpers.InputPrompt(this);return prompt.setValidationPatterns([{pattern:/[<>:"/\\\|\?\*]/,expectedTestResult:!1},{pattern:/^(?:CON|PRN|AUX|NUL|COM\d|LPT\d)(?:\.[^.]*)?$/,expectedTestResult:!1}]),prompt.setLocalizations({labelText:this.__expandLocalizationSymbol("Popup_Label_Name"),buttonTextOk:this.__expandLocalizationSymbol("Popup_Button_Text_OK"),buttonTooltipOk:this.__expandLocalizationSymbol("Popup_Button_Tooltip_OK"),buttonTextCancel:this.__expandLocalizationSymbol("Popup_Button_Text_Cancel"),buttonTooltipCancel:this.__expandLocalizationSymbol("Popup_Button_Tooltip_Cancel")}),prompt}async __createFolder(path){this.__namePrompt||(this.__namePrompt=this.__createNamePrompt()),this.__namePrompt.setLocalizations({headerText:this.__expandLocalizationSymbol("Popup_Header_NewFolder")});const forbidden=new Set(this.__directoryBrowser.getCurrentFolder()?.children.keys());forbidden.add("").add("..").add("::").add("/");const answer=await this.__namePrompt.prompt(forbidden,this.__localizationReader?.get("New_Folder"));answer.isOk&&TcHmi.Server.writeSymbolEx("Upload",{fileName:path.combine(answer.value).toString(),isDirectory:!0},null,(data=>{if(data.error===TcHmi.Errors.NONE&&data.results)for(const result of data.results)result.error!==TcHmi.Errors.NONE&&TCHMI_CONSOLE_LOG_LEVEL>=1&&TcHmi.Log.errorEx(`[Source=Control, Module=${this.__type+(__classPrivateFieldGet(TcHmiFileExplorer,_a,"f",_TcHmiFileExplorer_tchmiFQN)!==this.__type?", Origin="+__classPrivateFieldGet(TcHmiFileExplorer,_a,"f",_TcHmiFileExplorer_tchmiFQN):"")}, Id=${this.getId()}, Symbol=Rename] `+TcHmi.Log.buildMessage(result.details));else TCHMI_CONSOLE_LOG_LEVEL>=1&&TcHmi.Log.errorEx(`[Source=Control, Module=${this.__type+(__classPrivateFieldGet(TcHmiFileExplorer,_a,"f",_TcHmiFileExplorer_tchmiFQN)!==this.__type?", Origin="+__classPrivateFieldGet(TcHmiFileExplorer,_a,"f",_TcHmiFileExplorer_tchmiFQN):"")}, Id=${this.getId()}, Symbol=Rename] `+TcHmi.Log.buildMessage(data.details))}))}__downloadFiles(path,items){if(0===items.length)return;const aElement=document.createElement("a");aElement.style.display="none",this.__element[0].appendChild(aElement);for(const file of items)file.type===Controls.Helpers.DirectoryBrowser.ItemType.File&&(aElement.download=file.name,aElement.href=path.combine(file.name).toString(),aElement.click());aElement.remove()}async __upload(){if(this.__root&&this.__path){const files=await this.__selectFiles();if(files){const existingNames=this.__directoryBrowser.getCurrentFolder()?.children.keys();this.__uploadFiles(this.__root.combine(this.__path),files,new Set(existingNames))}}}__selectFiles(){return new Promise((resolve=>{const inputElement=document.createElement("input");inputElement.type="file",inputElement.multiple=!0,inputElement.addEventListener("change",(()=>{resolve(inputElement.files),inputElement.remove()})),inputElement.click()}))}async __uploadFiles(path,files,existingNames){const filesToQueue=new Map,conflictingNames=new Set;for(const file of files)existingNames.has(file.name)&&conflictingNames.add(file.name),filesToQueue.set(file.name,{file:file,path:path.combine(file.name).toString()});if(0!==conflictingNames.size){const result=await this.__resolveFileNameConflicts(conflictingNames,existingNames);if(!result.isOk)return;for(const name of conflictingNames){const resolvedName=result.value.get(name);if(resolvedName){if(resolvedName!==name){const fileToQueue=filesToQueue.get(name);fileToQueue&&(fileToQueue.path=path.combine(resolvedName).toString())}}else filesToQueue.delete(name)}}this.__fileUploader||(this.__fileUploader=new Beckhoff.TcHmiFileExplorerComponents.FileUploader);const errors=[];for(const[name,fileToQueue]of filesToQueue)this.__fileUploader.queue(fileToQueue.path,fileToQueue.file).then((result=>{result.error!==TcHmi.Errors.NONE&&(errors.push(`${name}: ${result.details?.message??"ERROR"}, ${result.details?.reason??"Unknown error"}`),this.__showErrorPopup(this.__expandLocalizationSymbol("Popup_Header_FileUploadError"),{symbolExpression:this.__expandLocalizationSymbol("Popup_Text_FileUploadError"),formatValues:[errors.join("\n")]}))}))}__showErrorPopup(headerText,contentText){return this.__errorPrompt||(this.__errorPrompt=new Controls.Helpers.TextAndButtonsPrompt({ok:{value:void 0,attributes:{"data-tchmi-width":60,"data-tchmi-height":30,"data-tchmi-text":this.__expandLocalizationSymbol("Popup_Button_Text_OK")}}},this)),this.__errorPrompt.setLocalizations({headerText:headerText,contentText:contentText}),this.__errorPrompt.isShowing()?Promise.resolve():this.__errorPrompt.prompt()}async __resolveFileNameConflicts(conflictingNames,existingNames){const currentFolder=this.__directoryBrowser.getCurrentFolder();if(!currentFolder)return{isOk:!1};const conflictMap=new Map,canDelete=TcHmi.Access.checkAccess(this,"delete")??!1;for(const name of conflictingNames){const fileFlags=currentFolder.children.get(name)?.payload.fileFlags??[];conflictMap.set(name,canDelete&&!fileFlags.includes("ReadOnly")&&!fileFlags.includes("UserAccessReadOnly"))}const popup=new Beckhoff.TcHmiFileExplorerComponents.FileConflictPrompt(conflictMap,existingNames,this);popup.setLocalizations({headerText:this.__expandLocalizationSymbol("Popup_Header_FileConflict"),labelText:this.__expandLocalizationSymbol("Popup_Label_FileConflict"),labelDoForAll:this.__expandLocalizationSymbol("Popup_FileConflict_Label_DoForAll"),radioTextSkip:this.__expandLocalizationSymbol("Popup_FileConflict_Radio_Text_Skip"),radioTextReplace:this.__expandLocalizationSymbol("Popup_FileConflict_Radio_Text_Replace"),radioTextKeepBoth:this.__expandLocalizationSymbol("Popup_FileConflict_Radio_Text_KeepBoth"),buttonTextOk:this.__expandLocalizationSymbol("Popup_Button_Text_OK"),buttonTextCancel:this.__expandLocalizationSymbol("Popup_Button_Text_Cancel"),buttonTooltipCancel:this.__expandLocalizationSymbol("Popup_Button_Tooltip_Cancel")});const result=await popup.prompt();return popup.destroy(!0),result}async __rename(path,name){this.__namePrompt||(this.__namePrompt=this.__createNamePrompt()),this.__namePrompt.setLocalizations({headerText:this.__expandLocalizationSymbol("Popup_Header_Rename")});const forbidden=new Set(this.__directoryBrowser.getCurrentFolder()?.children.keys());forbidden.add("").add("..").add("::").add("/");const answer=await this.__namePrompt.prompt(forbidden,name);if(answer.isOk){const vPath=new Beckhoff.TcHmiFileExplorerComponents.Path("VIRTUALDIRECTORIES::").combine(path);TcHmi.Server.writeSymbolEx("Rename",{old:vPath.combine(name).toString(),new:vPath.combine(answer.value).toString()},null,(data=>{if(data.error===TcHmi.Errors.NONE&&data.results)for(const result of data.results)result.error!==TcHmi.Errors.NONE&&TCHMI_CONSOLE_LOG_LEVEL>=1&&TcHmi.Log.errorEx(`[Source=Control, Module=${this.__type+(__classPrivateFieldGet(TcHmiFileExplorer,_a,"f",_TcHmiFileExplorer_tchmiFQN)!==this.__type?", Origin="+__classPrivateFieldGet(TcHmiFileExplorer,_a,"f",_TcHmiFileExplorer_tchmiFQN):"")}, Id=${this.getId()}, Symbol=Rename] `+TcHmi.Log.buildMessage(result.details));else TCHMI_CONSOLE_LOG_LEVEL>=1&&TcHmi.Log.errorEx(`[Source=Control, Module=${this.__type+(__classPrivateFieldGet(TcHmiFileExplorer,_a,"f",_TcHmiFileExplorer_tchmiFQN)!==this.__type?", Origin="+__classPrivateFieldGet(TcHmiFileExplorer,_a,"f",_TcHmiFileExplorer_tchmiFQN):"")}, Id=${this.getId()}, Symbol=Rename] `+TcHmi.Log.buildMessage(data.details))}))}}async __paste(targetPath,existingNames){if(!this.__clipboard)return;const pathChanges=[],conflictingNames=new Map;for(const path of this.__clipboard.items){const name=path.getName(),pathChange={old:path,new:targetPath.combine(name)};pathChanges.push(pathChange),existingNames.has(name)&&conflictingNames.set(name,pathChange),existingNames.add(name)}if(conflictingNames.size>0){const result=await this.__resolveFileNameConflicts(conflictingNames.keys(),existingNames);if(!result.isOk)return;for(const[name,pathChange]of conflictingNames){const resolvedName=result.value.get(name);if(resolvedName)pathChange.new=targetPath.combine(resolvedName);else{const index=pathChanges.indexOf(pathChange);void 0!==index&&index>-1&&pathChanges.splice(index,1)}}}if(0===pathChanges.length)return;const vPath=new Beckhoff.TcHmiFileExplorerComponents.Path("VIRTUALDIRECTORIES::"),symbolName="copy"===this.__clipboard.action?"Copy":"Rename",request={requestType:"ReadWrite",commands:pathChanges.map((pathChange=>({symbol:symbolName,commandOptions:["SendErrorMessage","SendWriteValue"],writeValue:{old:vPath.combine(pathChange.old).toString(),new:vPath.combine(pathChange.new).toString()}})))};let serverErrored=!1;TcHmi.Server.requestEx(request,null,(data=>{if(data.error!==TcHmi.Errors.NONE||!data.results)return TCHMI_CONSOLE_LOG_LEVEL>=1&&TcHmi.Log.errorEx(`[Source=Control, Module=${this.__type+(__classPrivateFieldGet(TcHmiFileExplorer,_a,"f",_TcHmiFileExplorer_tchmiFQN)!==this.__type?", Origin="+__classPrivateFieldGet(TcHmiFileExplorer,_a,"f",_TcHmiFileExplorer_tchmiFQN):"")}, Id=${this.getId()}, Symbol=${symbolName}] `+TcHmi.Log.buildMessage(data.details)),void(serverErrored=!0);for(const result of data.results)result.error!==TcHmi.Errors.NONE&&(TCHMI_CONSOLE_LOG_LEVEL>=1&&TcHmi.Log.errorEx(`[Source=Control, Module=${this.__type+(__classPrivateFieldGet(TcHmiFileExplorer,_a,"f",_TcHmiFileExplorer_tchmiFQN)!==this.__type?", Origin="+__classPrivateFieldGet(TcHmiFileExplorer,_a,"f",_TcHmiFileExplorer_tchmiFQN):"")}, Id=${this.getId()}, Symbol=${symbolName}] `+TcHmi.Log.buildMessage(result.details)),serverErrored=!0)})),serverErrored||"cut"!==this.__clipboard.action||(this.__clipboard.action="copy",this.__clipboard.items=pathChanges.map((pathChange=>pathChange.new)),this.__updateButtonAccess(),this.__buttons.paste.setVirtualControlRightMappings([{controlRight:"operate",virtualControlRight:"create"}]))}async __delete(path,items){const undeletableItems=items.filter((item=>item.payload.fileFlags.includes("VirtualDirectory")||item.payload.fileFlags.includes("ReadOnly")||item.payload.fileFlags.includes("UserAccessReadOnly")));if(0!==undeletableItems.length&&(items=items.filter((item=>!undeletableItems.includes(item))),await this.__showErrorPopup(this.__expandLocalizationSymbol("Popup_Header_DeleteError"),{symbolExpression:this.__expandLocalizationSymbol("Popup_Text_DeleteError"),formatValues:[undeletableItems.map((item=>item.name)).join("\n")]})),0===items.length)return;this.__confirmationPrompt||(this.__confirmationPrompt=new Controls.Helpers.TextAndButtonsPrompt({yes:{value:!0,attributes:{"data-tchmi-width":60,"data-tchmi-height":30,"data-tchmi-text":this.__expandLocalizationSymbol("Popup_Button_Text_Yes")}},no:{value:!1,attributes:{"data-tchmi-width":60,"data-tchmi-height":30,"data-tchmi-text":this.__expandLocalizationSymbol("Popup_Button_Text_No")}}},this),this.__confirmationPrompt.setLocalizations({headerText:this.__expandLocalizationSymbol("Popup_Header_ConfirmDelete"),contentText:this.__expandLocalizationSymbol("Popup_Text_ConfirmDelete")}));if(await this.__confirmationPrompt.prompt()){const request={requestType:"ReadWrite",commands:items.map((item=>({symbol:"Delete",commandOptions:["SendErrorMessage","SendWriteValue"],writeValue:{fileName:path.combine(item.name).toString()}})))};TcHmi.Server.requestEx(request,null,(data=>{if(data.error===TcHmi.Errors.NONE&&data.results)for(const result of data.results)result.error!==TcHmi.Errors.NONE&&TCHMI_CONSOLE_LOG_LEVEL>=1&&TcHmi.Log.errorEx(`[Source=Control, Module=${this.__type+(__classPrivateFieldGet(TcHmiFileExplorer,_a,"f",_TcHmiFileExplorer_tchmiFQN)!==this.__type?", Origin="+__classPrivateFieldGet(TcHmiFileExplorer,_a,"f",_TcHmiFileExplorer_tchmiFQN):"")}, Id=${this.getId()}, Symbol=Delete] `+TcHmi.Log.buildMessage(result.details));else TCHMI_CONSOLE_LOG_LEVEL>=1&&TcHmi.Log.errorEx(`[Source=Control, Module=${this.__type+(__classPrivateFieldGet(TcHmiFileExplorer,_a,"f",_TcHmiFileExplorer_tchmiFQN)!==this.__type?", Origin="+__classPrivateFieldGet(TcHmiFileExplorer,_a,"f",_TcHmiFileExplorer_tchmiFQN):"")}, Id=${this.getId()}, Symbol=Delete] `+TcHmi.Log.buildMessage(data.details))}))}}__localizeListBrowsingDisplay(){if(!this.__localizationReader)return;const labelFileSize=this.__localizationReader.get("Metadata_Label_FileSize"),labelModificationTime=this.__localizationReader.get("Metadata_Label_ModificationTime"),labelVirtualDirectory=this.__localizationReader.get("Metadata_Label_VirtualDirectory"),labelReadOnly=this.__localizationReader.get("Metadata_Label_ReadOnly");this.__listBrowsingDisplay.showMetadata((item=>{const metadata=[];return void 0!==item.payload.fileSize&&metadata.push(`${labelFileSize}: ${function(size){const units=["kB","MB","GB"];let index=0;for(;size>1e3&&index<units.length-1;)size/=1e3,index++;return size.toFixed(3)+" "+units[index]}(item.payload.fileSize)}`),item.payload.modificationTime&&metadata.push(`${labelModificationTime}: ${TcHmi.Localization.formatDate(new Date(item.payload.modificationTime))}`),item.payload.fileFlags.includes("VirtualDirectory")&&metadata.push(labelVirtualDirectory),(item.payload.fileFlags.includes("ReadOnly")||item.payload.fileFlags.includes("UserAccessReadOnly"))&&metadata.push(labelReadOnly),metadata.join("   |   ")}))}setRoot(valueNew){let convertedValue=TcHmi.ValueConverter.toString(valueNew);null===convertedValue&&(convertedValue=this.getAttributeDefaultValueInternal("Root")),tchmi_equal(convertedValue,this.__root?.original)||(this.__root=new Beckhoff.TcHmiFileExplorerComponents.Path(convertedValue,!0),TcHmi.EventProvider.raise(this.__id+".onPropertyChanged",{propertyName:"Root"}),this.__processRoot())}getRoot(){return this.__root?.original}__processRoot(){this.__processPath()}setPath(valueNew){let convertedValue=TcHmi.ValueConverter.toString(valueNew);null===convertedValue&&(convertedValue=this.getAttributeDefaultValueInternal("Path")),tchmi_equal(convertedValue,this.__path?.original)||(this.__path=new Beckhoff.TcHmiFileExplorerComponents.Path(convertedValue),TcHmi.EventProvider.raise(this.__id+".onPropertyChanged",{propertyName:"Path"}),this.__processPath())}getPath(){return this.__path?.original}async __processPath(){if(!this.__root||!this.__path)return;TcHmi.EventProvider.raise(this.__id+".onPropertyChanged",{propertyName:"FullPath"}),TcHmi.EventProvider.raise(this.__id+".onPathChanged"),await this.__updateSubscription();!await this.__directoryBrowser.setPath(this.__path.toArray())&&TCHMI_CONSOLE_LOG_LEVEL>=1&&TcHmi.Log.errorEx(`[Source=Control, Module=${this.__type+(__classPrivateFieldGet(TcHmiFileExplorer,_a,"f",_TcHmiFileExplorer_tchmiFQN)!==this.__type?", Origin="+__classPrivateFieldGet(TcHmiFileExplorer,_a,"f",_TcHmiFileExplorer_tchmiFQN):"")}, Id=${this.getId()}, Property=Path] `+TcHmi.Log.buildMessage({code:TcHmi.Errors.E_INVALID,message:TcHmi.Errors[TcHmi.Errors.E_INVALID],reason:`The path "${this.__path.original}" cannot be found under the root "${this.__root.original}". Please check if both path and root are correct.`,domain:this.__type}))}getFullPath(){return this.__root&&this.__path?this.__root.combine(this.__path).toString():""}getSelectedItems(){return(this.__directoryBrowser.getSelectedItems()??[]).map((item=>item.name))}setServerInterval(valueNew){let convertedValue=TcHmi.ValueConverter.toNumber(valueNew);null===convertedValue&&(convertedValue=this.getAttributeDefaultValueInternal("ServerInterval")),tchmi_equal(convertedValue,this.__serverInterval)||(this.__serverInterval=convertedValue,TcHmi.EventProvider.raise(this.__id+".onPropertyChanged",{propertyName:"ServerInterval"}),this.__processServerInterval())}getServerInterval(){return this.__serverInterval}__processServerInterval(){this.__updateSubscription(),this.__updateSymbolAccessSubscription()}setMenuBarPosition(valueNew){let convertedValue=TcHmi.ValueConverter.toString(valueNew);(null===convertedValue||"Top"!==convertedValue&&"Bottom"!==convertedValue)&&(convertedValue=this.getAttributeDefaultValueInternal("MenuBarPosition")),tchmi_equal(convertedValue,this.__menuBarPosition)||(this.__menuBarPosition=convertedValue,TcHmi.EventProvider.raise(this.__id+".onPropertyChanged",{propertyName:"MenuBarPosition"}),this.__processLayout())}getMenuBarPosition(){return this.__menuBarPosition}setMenuBarHeight(valueNew){let convertedValue=TcHmi.ValueConverter.toNumber(valueNew);null===convertedValue&&(convertedValue=this.getAttributeDefaultValueInternal("MenuBarHeight")),tchmi_equal(convertedValue,this.__menuBarHeight)||(this.__menuBarHeight=convertedValue,TcHmi.EventProvider.raise(this.__id+".onPropertyChanged",{propertyName:"MenuBarHeight"}),this.__processLayout())}getMenuBarHeight(){return this.__menuBarHeight}getMenuBarHeightUnit(){return"px"}__processLayout(){if(!this.__menuBarPosition||void 0===this.__menuBarHeight||void 0===this.__showNavigationPane||!this.__navigationPanePosition)return;this.__elementDirectoryTree.style.display=this.__showNavigationPane?"":"none";const gridTemplateExplorer=(this.__showNavigationPane?"Right"!==this.__navigationPanePosition?"'tree browsing'":"'browsing tree'":"'browsing browsing'")+"minmax(0, 1fr)",gridTemplate=("Bottom"!==this.__menuBarPosition?`'menu menu' auto\n${gridTemplateExplorer}`:`${gridTemplateExplorer}\n'menu menu' auto`)+" / auto 1fr";this.__elementTemplateRoot.style.gridTemplate=gridTemplate;for(const button of Object.values(this.__buttons))button.setHeight(this.__menuBarHeight),button.setWidth(this.__menuBarHeight)}__updateSubscription(unsubscribeOnly=!1){return TCHMI_DESIGNER?Promise.resolve():new Promise((resolve=>{if(null!==this.__subscriptionId&&(TcHmi.Server.unsubscribeEx(this.__subscriptionId,null),this.__subscriptionId=null),!unsubscribeOnly&&this.__isAttached){if(this.__root&&this.__path){const handler=this.__getListFilesHandler(this.__path);this.__subscriptionId=TcHmi.Server.subscribeEx([{symbol:"ListFiles",writeValue:"/"+this.__root.combine(this.__path).toString(),commandOptions:["SendWriteValue","SendErrorMessage"]}],this.__serverInterval??TcHmi.Config.get().tcHmiServer.websocketIntervalTime,null,(data=>{handler(data),resolve()}))}}else resolve()}))}__getListFilesHandler(path){return data=>{if(data.error!==TcHmi.Errors.NONE)return void(TCHMI_CONSOLE_LOG_LEVEL>=1&&TcHmi.Log.errorEx(`[Source=Control, Module=${this.__type+(__classPrivateFieldGet(TcHmiFileExplorer,_a,"f",_TcHmiFileExplorer_tchmiFQN)!==this.__type?", Origin="+__classPrivateFieldGet(TcHmiFileExplorer,_a,"f",_TcHmiFileExplorer_tchmiFQN):"")}, Id=${this.getId()}, Symbol=ListFiles] `+TcHmi.Log.buildMessage(data.details)));if(!data.response)return void(TCHMI_CONSOLE_LOG_LEVEL>=1&&TcHmi.Log.errorEx(`[Source=Control, Module=${this.__type+(__classPrivateFieldGet(TcHmiFileExplorer,_a,"f",_TcHmiFileExplorer_tchmiFQN)!==this.__type?", Origin="+__classPrivateFieldGet(TcHmiFileExplorer,_a,"f",_TcHmiFileExplorer_tchmiFQN):"")}, Id=${this.getId()}, Symbol=ListFiles] `+TcHmi.Log.buildMessage({code:TcHmi.Errors.E_SERVER_RESPONSE_MISSING,message:TcHmi.Errors[TcHmi.Errors.E_SERVER_RESPONSE_MISSING],reason:"Missing response from server.",domain:this.__type})));if(data.response.error)return void(TCHMI_CONSOLE_LOG_LEVEL>=1&&TcHmi.Log.errorEx(`[Source=Control, Module=${this.__type+(__classPrivateFieldGet(TcHmiFileExplorer,_a,"f",_TcHmiFileExplorer_tchmiFQN)!==this.__type?", Origin="+__classPrivateFieldGet(TcHmiFileExplorer,_a,"f",_TcHmiFileExplorer_tchmiFQN):"")}, Id=${this.getId()}, Symbol=ListFiles] `+TcHmi.Log.buildMessage(data.response.error)));if(!data.response.commands||!data.response.commands[0])return void(TCHMI_CONSOLE_LOG_LEVEL>=1&&TcHmi.Log.errorEx(`[Source=Control, Module=${this.__type+(__classPrivateFieldGet(TcHmiFileExplorer,_a,"f",_TcHmiFileExplorer_tchmiFQN)!==this.__type?", Origin="+__classPrivateFieldGet(TcHmiFileExplorer,_a,"f",_TcHmiFileExplorer_tchmiFQN):"")}, Id=${this.getId()}, Symbol=ListFiles] `+TcHmi.Log.buildMessage({code:TcHmi.Errors.E_SERVER_COMMANDS_MISSING,message:TcHmi.Errors[TcHmi.Errors.E_SERVER_COMMANDS_MISSING],reason:`Missing commands in response from server with id: '${data.response.id}'.`,domain:this.__type})));if(data.response.commands[0].error)return void(TCHMI_CONSOLE_LOG_LEVEL>=1&&TcHmi.Log.errorEx(`[Source=Control, Module=${this.__type+(__classPrivateFieldGet(TcHmiFileExplorer,_a,"f",_TcHmiFileExplorer_tchmiFQN)!==this.__type?", Origin="+__classPrivateFieldGet(TcHmiFileExplorer,_a,"f",_TcHmiFileExplorer_tchmiFQN):"")}, Id=${this.getId()}, Symbol=ListFiles] `+TcHmi.Log.buildMessage(data.response.commands[0].error)));const readValue=data.response.commands[0].readValue;readValue?this.__updateDirectory(readValue,path):TCHMI_CONSOLE_LOG_LEVEL>=1&&TcHmi.Log.errorEx(`[Source=Control, Module=${this.__type+(__classPrivateFieldGet(TcHmiFileExplorer,_a,"f",_TcHmiFileExplorer_tchmiFQN)!==this.__type?", Origin="+__classPrivateFieldGet(TcHmiFileExplorer,_a,"f",_TcHmiFileExplorer_tchmiFQN):"")}, Id=${this.getId()}, Symbol=ListFiles] `+TcHmi.Log.buildMessage({code:TcHmi.Errors.E_SERVER_READVALUE_MISSING,message:TcHmi.Errors[TcHmi.Errors.E_SERVER_READVALUE_MISSING],reason:`Missing readValue in response from server with id: '${data.response.id}'.`,domain:this.__type}))}}__updateDirectory(fileList,path){let current=this.__directory;for(const pathItem of path.toArray()){current.children||(current.children=new Map);let next=current.children.get(pathItem);next||(next={fileFlags:["Directory"]},current.children.set(pathItem,next)),current=next}if(current.children)for(const name of current.children.keys())name in fileList||current.children.delete(name);else current.children=new Map;for(const[name,entry]of Object.entries(fileList)){const child=current.children.get(name);child?(child.fileFlags=entry.fileFlags,child.fileSize=entry.fileSize,child.link=entry.link,child.modificationTime=entry.modificationTime):current.children.set(name,entry)}const updateButtons=null===this.__directoryBrowser.getCurrentItem();this.__directoryBrowser.setDirectory(this.__directory,(folder=>folder.children??new Map),(candidate=>!candidate.fileFlags.includes("Directory")&&!candidate.fileFlags.includes("VirtualDirectory")),(item=>({fileFlags:item.fileFlags,fileSize:item.fileSize,link:item.link,modificationTime:item.modificationTime}))),updateButtons&&this.__updateButtonsEnabled()}__updateSymbolAccessSubscription(unsubscribeOnly=!1){if(TCHMI_DESIGNER)return;if(null!==this.__symbolAccessSubscriptionId&&(TcHmi.Server.unsubscribeEx(this.__symbolAccessSubscriptionId,null),this.__symbolAccessSubscriptionId=null),unsubscribeOnly||!this.__isAttached)return;const commands=Object.keys(this.__symbolAccess).map((symbolName=>({symbol:"GetSymbolAccess",writeValue:symbolName,commandOptions:["SendWriteValue","SendErrorMessage"]})));this.__symbolAccessSubscriptionId=TcHmi.Server.subscribeEx(commands,this.__serverInterval??TcHmi.Config.get().tcHmiServer.websocketIntervalTime,null,(data=>{if(data.error===TcHmi.Errors.NONE)if(data.response)if(data.response.error)TCHMI_CONSOLE_LOG_LEVEL>=1&&TcHmi.Log.errorEx(`[Source=Control, Module=${this.__type+(__classPrivateFieldGet(TcHmiFileExplorer,_a,"f",_TcHmiFileExplorer_tchmiFQN)!==this.__type?", Origin="+__classPrivateFieldGet(TcHmiFileExplorer,_a,"f",_TcHmiFileExplorer_tchmiFQN):"")}, Id=${this.getId()}, Symbol=GetSymbolAccess] `+TcHmi.Log.buildMessage(data.response.error));else if(data.response.commands){for(const command of data.response.commands)command.error?TCHMI_CONSOLE_LOG_LEVEL>=1&&TcHmi.Log.errorEx(`[Source=Control, Module=${this.__type+(__classPrivateFieldGet(TcHmiFileExplorer,_a,"f",_TcHmiFileExplorer_tchmiFQN)!==this.__type?", Origin="+__classPrivateFieldGet(TcHmiFileExplorer,_a,"f",_TcHmiFileExplorer_tchmiFQN):"")}, Id=${this.getId()}, Symbol=GetSymbolAccess] `+TcHmi.Log.buildMessage(command.error)):void 0!==command.readValue?command.writeValue?this.__symbolAccess[command.writeValue]=command.readValue:TCHMI_CONSOLE_LOG_LEVEL>=1&&TcHmi.Log.errorEx(`[Source=Control, Module=${this.__type+(__classPrivateFieldGet(TcHmiFileExplorer,_a,"f",_TcHmiFileExplorer_tchmiFQN)!==this.__type?", Origin="+__classPrivateFieldGet(TcHmiFileExplorer,_a,"f",_TcHmiFileExplorer_tchmiFQN):"")}, Id=${this.getId()}, Symbol=GetSymbolAccess] `+TcHmi.Log.buildMessage({code:TcHmi.Errors.E_SERVER_WRITEVALUE_MISSING,message:TcHmi.Errors[TcHmi.Errors.E_SERVER_WRITEVALUE_MISSING],reason:`Missing writeValue in response from server with id: '${data.response.id}'.`,domain:this.__type})):TCHMI_CONSOLE_LOG_LEVEL>=1&&TcHmi.Log.errorEx(`[Source=Control, Module=${this.__type+(__classPrivateFieldGet(TcHmiFileExplorer,_a,"f",_TcHmiFileExplorer_tchmiFQN)!==this.__type?", Origin="+__classPrivateFieldGet(TcHmiFileExplorer,_a,"f",_TcHmiFileExplorer_tchmiFQN):"")}, Id=${this.getId()}, Symbol=GetSymbolAccess] `+TcHmi.Log.buildMessage({code:TcHmi.Errors.E_SERVER_READVALUE_MISSING,message:TcHmi.Errors[TcHmi.Errors.E_SERVER_READVALUE_MISSING],reason:`Missing readValue in response from server with id: '${data.response.id}'.`,domain:this.__type}));this.__updateButtonAccess()}else TCHMI_CONSOLE_LOG_LEVEL>=1&&TcHmi.Log.errorEx(`[Source=Control, Module=${this.__type+(__classPrivateFieldGet(TcHmiFileExplorer,_a,"f",_TcHmiFileExplorer_tchmiFQN)!==this.__type?", Origin="+__classPrivateFieldGet(TcHmiFileExplorer,_a,"f",_TcHmiFileExplorer_tchmiFQN):"")}, Id=${this.getId()}, Symbol=GetSymbolAccess] `+TcHmi.Log.buildMessage({code:TcHmi.Errors.E_SERVER_COMMANDS_MISSING,message:TcHmi.Errors[TcHmi.Errors.E_SERVER_COMMANDS_MISSING],reason:`Missing commands in response from server with id: '${data.response.id}'.`,domain:this.__type}));else TCHMI_CONSOLE_LOG_LEVEL>=1&&TcHmi.Log.errorEx(`[Source=Control, Module=${this.__type+(__classPrivateFieldGet(TcHmiFileExplorer,_a,"f",_TcHmiFileExplorer_tchmiFQN)!==this.__type?", Origin="+__classPrivateFieldGet(TcHmiFileExplorer,_a,"f",_TcHmiFileExplorer_tchmiFQN):"")}, Id=${this.getId()}, Symbol=GetSymbolAccess] `+TcHmi.Log.buildMessage({code:TcHmi.Errors.E_SERVER_RESPONSE_MISSING,message:TcHmi.Errors[TcHmi.Errors.E_SERVER_RESPONSE_MISSING],reason:"Missing response from server.",domain:this.__type}));else TCHMI_CONSOLE_LOG_LEVEL>=1&&TcHmi.Log.errorEx(`[Source=Control, Module=${this.__type+(__classPrivateFieldGet(TcHmiFileExplorer,_a,"f",_TcHmiFileExplorer_tchmiFQN)!==this.__type?", Origin="+__classPrivateFieldGet(TcHmiFileExplorer,_a,"f",_TcHmiFileExplorer_tchmiFQN):"")}, Id=${this.getId()}, Symbol=GetSymbolAccess] `+TcHmi.Log.buildMessage(data.details))}))}}_TcHmiFileExplorer_tchmiFQN={value:"TcHmi.Controls.Beckhoff."+(_a=TcHmiFileExplorer).name},Beckhoff.TcHmiFileExplorer=TcHmiFileExplorer,function(TcHmiFileExplorer){let SymbolAccess;!function(SymbolAccess){SymbolAccess[SymbolAccess.None=0]="None",SymbolAccess[SymbolAccess.Read=1]="Read",SymbolAccess[SymbolAccess.Write=2]="Write",SymbolAccess[SymbolAccess.ReadWrite=3]="ReadWrite"}(SymbolAccess=TcHmiFileExplorer.SymbolAccess||(TcHmiFileExplorer.SymbolAccess={}))}(TcHmiFileExplorer=Beckhoff.TcHmiFileExplorer||(Beckhoff.TcHmiFileExplorer={}))}(Controls.Beckhoff||(Controls.Beckhoff={}))}(TcHmi.Controls||(TcHmi.Controls={}))}(TcHmi||(TcHmi={})),TcHmi.Controls.registerEx("TcHmiFileExplorer","TcHmi.Controls.Beckhoff",TcHmi.Controls.Beckhoff.TcHmiFileExplorer),function(TcHmi){!function(Controls){!function(Beckhoff){!function(TcHmiFileExplorerComponents){class Path{constructor(path,root=!1){this.__original=path;let parsedPath="string"==typeof path?path.split("/"):path;parsedPath=parsedPath.filter((item=>""!==item));const rootParts="number"==typeof root?root:0;for(let i=0;i<parsedPath.length&&i>=0;i++)".."===parsedPath[i]&&(i>rootParts?(parsedPath.splice(i-1,2),i-=2):!1!==root&&(parsedPath.splice(i,1),i--));this.__path=parsedPath,this.__rootParts="boolean"==typeof root?root?parsedPath.length:0:root}get original(){return this.__original}get length(){return this.__path.length}get(index){return this.__path[index]}getName(){return this.__path[this.__path.length-1]}toString(){return this.__path.join("/")}toArray(){return this.__path}combine(path){return"string"==typeof path?new Path(this.__path.concat(path.split("/")),this.__rootParts):Array.isArray(path)?new Path(this.__path.concat(path),this.__rootParts):new Path(this.__path.concat(path.toArray()),this.__rootParts)}}TcHmiFileExplorerComponents.Path=Path}(Beckhoff.TcHmiFileExplorerComponents||(Beckhoff.TcHmiFileExplorerComponents={}))}(Controls.Beckhoff||(Controls.Beckhoff={}))}(TcHmi.Controls||(TcHmi.Controls={}))}(TcHmi||(TcHmi={})),function(TcHmi){!function(Controls){!function(Beckhoff){!function(TcHmiFileExplorerComponents){class FileConflictPrompt extends Controls.Helpers.OkCancelPrompt{constructor(conflictingNames,existingNames,parentControl){super(parentControl),this.__doAll=void 0,this.__onRadioStateChanged=()=>{let isValid=!0;const allActive={skip:!0,replace:!0,both:!0};for(const controls of this.__rows.values()){let activeRadios=0;for(const[controlName,radio]of Object.entries(controls))"Active"===radio.getRadioState()&&radio.getIsEnabled()?activeRadios++:allActive[controlName]=!1;if(1!==activeRadios){isValid=!1;break}}this.__okButton.setIsEnabled(isValid),this.__doAll&&(this.__doAll.controls.skip.setRadioState(allActive.skip&&isValid?"Active":"Normal"),this.__doAll.controls.replace.setRadioState(allActive.replace&&isValid?"Active":"Normal"),this.__doAll.controls.both.setRadioState(allActive.both&&isValid?"Active":"Normal"))},this.__existingNames=new Set(existingNames),this.__elementLabel=this.__elementContent.appendChild(document.createElement("span")),this.__elementLabel.className=`${this.__className}-label-block`;const elementScrollContainer=this.__elementContent.appendChild(document.createElement("div"));elementScrollContainer.className=`${this.__className}-scroll-container`,this.__rows=new Map;for(const[name,replaceable]of conflictingNames){const row=this.__buildRow(name,replaceable,this.__onRadioStateChanged);elementScrollContainer.appendChild(row.container),this.__rows.set(name,row.controls)}if(this.__rows.size>1){const row=this.__buildRow("");TcHmi.EventProvider.register(row.controls.skip.getId()+".onRadioStateChanged",this.__getOnAllRadioStateChangedHandler("skip")),TcHmi.EventProvider.register(row.controls.replace.getId()+".onRadioStateChanged",this.__getOnAllRadioStateChangedHandler("replace")),TcHmi.EventProvider.register(row.controls.both.getId()+".onRadioStateChanged",this.__getOnAllRadioStateChangedHandler("both")),this.__elementContent.insertBefore(row.container,elementScrollContainer),this.__doAll={label:row.label,controls:row.controls}}}destroy(force=!1){for(const row of this.__rows.values())TcHmi.Binding.removeEx2(null,"Text",row.skip),TcHmi.Binding.removeEx2(null,"Text",row.replace),TcHmi.Binding.removeEx2(null,"Text",row.both);this.__doAll&&(TcHmi.Binding.removeEx2(null,"Text",this.__doAll.controls.skip),TcHmi.Binding.removeEx2(null,"Text",this.__doAll.controls.replace),TcHmi.Binding.removeEx2(null,"Text",this.__doAll.controls.both)),super.destroy(force)}__buildRow(labelText,replaceable=!0,eventHandler){const container=document.createElement("div");container.className=`${this.__className}-radio-row`;const label=container.appendChild(document.createElement("span"));label.textContent=labelText;const guid=tchmi_create_guid(),[skip,replace,both]=["skip","replace","both"].map((controlName=>{const control=TcHmi.ControlFactory.createEx("TcHmi.Controls.Beckhoff.TcHmiRadioButton",`${this.__name}.${controlName}.${guid}`,{"data-tchmi-radio-group":guid,"data-tchmi-is-enabled":"replace"!==controlName||replaceable,"data-tchmi-ignore-escape-sequences":!0},this.__parentControl);if(!control)throw new Error("Could not create controls for FileConflictPrompt");return eventHandler&&TcHmi.EventProvider.register(control.getId()+".onRadioStateChanged",eventHandler),container.appendChild(control.getElement()[0]),this.__childControls.push(control),control}));return{container:container,label:label,controls:{skip:skip,replace:replace,both:both}}}__getOnAllRadioStateChangedHandler(name){return()=>{for(const controls of this.__rows.values())controls[name].getIsEnabled()&&controls[name].setRadioState("Active")}}__ok(){const answerValue=new Map;for(const[name,controls]of this.__rows)if("Active"===controls.replace.getRadioState())answerValue.set(name,name),this.__existingNames.add(name);else if("Active"===controls.both.getRadioState()){const dotIndex=name.lastIndexOf(".");let rawName=dotIndex>0?name.slice(0,dotIndex):name;const extension=dotIndex>0?name.slice(dotIndex):"",counterEnding=rawName.match(/\((\d+)\)$/);let counter,newName;counterEnding?(counter=parseInt(counterEnding[1],10),rawName=rawName.slice(0,counterEnding.index),Number.isNaN(counter)&&(counter=0)):(counter=0,rawName+=" ");do{counter++,newName=`${rawName}(${counter})${extension}`}while(this.__existingNames.has(newName));answerValue.set(name,newName),this.__existingNames.add(newName)}this.__prompt?.answer({isOk:!0,value:answerValue})}setLocalizations(texts){if(super.setLocalizations(texts),texts.headerText&&this.__watchLocalization("headerText","string"==typeof texts.headerText?{symbolExpression:texts.headerText,formatValues:[]}:texts.headerText,(text=>this.__elementHeader.textContent=text)),texts.labelText&&this.__watchLocalization("labelText","string"==typeof texts.labelText?{symbolExpression:texts.labelText,formatValues:[]}:texts.labelText,(text=>this.__elementLabel.textContent=text)),texts.labelDoForAll&&this.__doAll&&this.__watchLocalization("labelDoForAll","string"==typeof texts.labelDoForAll?{symbolExpression:texts.labelDoForAll,formatValues:[]}:texts.labelDoForAll,(text=>this.__doAll.label.textContent=text)),texts.radioTextSkip)if("string"==typeof texts.radioTextSkip){this.__unwatchLocalization("buttonTextSkip");for(const row of this.__rows.values())TcHmi.Binding.createEx2(texts.radioTextSkip,"Text",row.skip);this.__doAll&&TcHmi.Binding.createEx2(texts.radioTextSkip,"Text",this.__doAll.controls.skip)}else{for(const row of this.__rows.values())TcHmi.Binding.removeEx2(null,"Text",row.skip);this.__doAll&&TcHmi.Binding.removeEx2(null,"Text",this.__doAll.controls.skip),this.__watchLocalization("buttonTextSkip",texts.radioTextSkip,(text=>{for(const row of this.__rows.values())row.skip.setText(text);this.__doAll&&this.__doAll.controls.skip.setText(text)}))}if(texts.radioTextReplace)if("string"==typeof texts.radioTextReplace){this.__unwatchLocalization("buttonTextReplace");for(const row of this.__rows.values())TcHmi.Binding.createEx2(texts.radioTextReplace,"Text",row.replace);this.__doAll&&TcHmi.Binding.createEx2(texts.radioTextReplace,"Text",this.__doAll.controls.replace)}else{for(const row of this.__rows.values())TcHmi.Binding.removeEx2(null,"Text",row.replace);this.__doAll&&TcHmi.Binding.removeEx2(null,"Text",this.__doAll.controls.replace),this.__watchLocalization("buttonTextReplace",texts.radioTextReplace,(text=>{for(const row of this.__rows.values())row.replace.setText(text);this.__doAll&&this.__doAll.controls.replace.setText(text)}))}if(texts.radioTextKeepBoth)if("string"==typeof texts.radioTextKeepBoth){this.__unwatchLocalization("buttonTextKeepBoth");for(const row of this.__rows.values())TcHmi.Binding.createEx2(texts.radioTextKeepBoth,"Text",row.both);this.__doAll&&TcHmi.Binding.createEx2(texts.radioTextKeepBoth,"Text",this.__doAll.controls.both)}else{for(const row of this.__rows.values())TcHmi.Binding.removeEx2(null,"Text",row.both);this.__doAll&&TcHmi.Binding.removeEx2(null,"Text",this.__doAll.controls.both),this.__watchLocalization("buttonTextKeepBoth",texts.radioTextKeepBoth,(text=>{for(const row of this.__rows.values())row.both.setText(text);this.__doAll&&this.__doAll.controls.both.setText(text)}))}}}TcHmiFileExplorerComponents.FileConflictPrompt=FileConflictPrompt}(Beckhoff.TcHmiFileExplorerComponents||(Beckhoff.TcHmiFileExplorerComponents={}))}(Controls.Beckhoff||(Controls.Beckhoff={}))}(TcHmi.Controls||(TcHmi.Controls={}))}(TcHmi||(TcHmi={})),function(TcHmi){!function(Controls){!function(Beckhoff){!function(TcHmiFileExplorerComponents){class FileUploader{constructor(__domain){this.__domain=__domain,this.__queueTimeoutId=0,FileUploader.__subscribedToChunkSize||FileUploader.__subscribeChunkSize()}queue(path,file,progressCallback){return new Promise((resolve=>{const queued={file:file,path:path,domain:this.__domain,offset:0,status:FileUploader.FileStatus.Pending,progressCallback:progress=>{progressCallback?.(progress),progress.error===TcHmi.Errors.NONE&&progress.status!==FileUploader.FileStatus.Finished&&progress.status!==FileUploader.FileStatus.Canceled||resolve(progress)}};this.cancel(path),FileUploader.__queue.push(queued),clearTimeout(this.__queueTimeoutId),FileUploader.__working||(this.__queueTimeoutId=setTimeout((()=>FileUploader.__workQueue()),50))}))}cancel(path){const index=FileUploader.__queue.findIndex((queuedFile=>queuedFile.path===path));return-1!==index&&(FileUploader.__queue[index].progressCallback({error:TcHmi.Errors.NONE,uploadedBytes:0,totalBytes:FileUploader.__queue[index].file.size,status:FileUploader.FileStatus.Canceled}),FileUploader.__queue.splice(index,1),!0)}static async __workQueue(){if(this.__chunkSizeSubscriptionError){for(const file of this.__queue)file.progressCallback(this.__chunkSizeSubscriptionError);return this.__queue=[],void(this.__working=!1)}if(null===this.__chunkSize)return void(this.__working=!0);if(0===this.__chunkSize){for(const file of this.__queue)file.progressCallback({error:TcHmi.Errors.E_INVALID,details:{code:TcHmi.Errors.E_INVALID,message:TcHmi.Errors[TcHmi.Errors.E_INVALID],reason:"The chunk size must be greater than 0."}});return this.__queue=[],void(this.__working=!1)}if(!this.__current&&0===this.__queue.length)return void(this.__working=!1);this.__working=!0;let remaining=this.__chunkSize;const chunks=new Map,fileReadPromises=[];for(;remaining>0&&(this.__current||0!==this.__queue.length)&&(this.__current||0===this.__queue.length||(this.__current=this.__queue.shift(),this.__current.status=FileUploader.FileStatus.Uploading,this.__current.progressCallback({error:TcHmi.Errors.NONE,uploadedBytes:0,totalBytes:this.__current.file.size,status:this.__current.status})),this.__current)&&!chunks.has(this.__current.path);){const current=this.__current,remainingFileSize=current.file.size-current.offset,firstChunk=0===current.offset,lastChunk=remainingFileSize<=this.__chunkSize,chunk={file:current,data:"",type:firstChunk&&lastChunk?FileUploader.ChunkType.Disabled:firstChunk?FileUploader.ChunkType.First:lastChunk?FileUploader.ChunkType.Last:FileUploader.ChunkType.Intermediate};chunks.set(current.path,chunk),fileReadPromises.push(this.__readFileData(current.file,current.offset,this.__chunkSize).then((data=>{chunk.data=data})).catch((reason=>{const error={error:TcHmi.Errors.ERROR,details:{code:TcHmi.Errors.ERROR,message:TcHmi.Errors[TcHmi.Errors.ERROR]}};reason instanceof Error&&(error.details.reason=reason.message),chunks.delete(current.path),current.progressCallback(error),this.__current===current&&(this.__current=null)})));const readBytes=Math.min(remainingFileSize,this.__chunkSize);current.offset+=readBytes,remaining-=readBytes,lastChunk&&(this.__current=null)}await Promise.all(fileReadPromises),0!==chunks.size?this.__upload(chunks):this.__workQueue()}static __readFileData(file,offset,limit){return new Promise(((resolve,reject)=>{const reader=new FileReader;if(reader.addEventListener("load",(event=>{"string"==typeof reader.result?resolve(reader.result.replace(/data:(?:.*,|$)/,"")):reject(new Error(reader.result?"Expected string, got ArrayBuffer":"Could not read file"))})),reader.addEventListener("abort",(event=>{reject(new Error("The reading operation was aborted"))})),reader.addEventListener("error",(event=>{reject(reader.error??new Error("An unspecified error occured while reading the file"))})),void 0!==offset){const end=void 0!==limit?Math.min(offset+limit,file.size):file.size;reader.readAsDataURL(file.slice(offset,end))}else reader.readAsDataURL(file)}))}static __upload(chunks){const request={requestType:"ReadWrite",commands:Array.from(chunks.values()).map((chunk=>({symbol:"Upload",commandOptions:["SendWriteValue","SendErrorMessage"],writeValue:{domain:chunk.file.domain,fileName:chunk.file.path,data:chunk.data,chunkType:chunk.type}})))};TcHmi.Server.requestEx(request,null,(data=>{if(data.error!==TcHmi.Errors.NONE){for(const chunk of chunks.values())chunk.file.progressCallback({error:data.error,details:data.details}),this.__current===chunk.file&&(this.__current=null);return void this.__workQueue()}if(!data.response){const details={code:TcHmi.Errors.E_SERVER_RESPONSE_MISSING,message:TcHmi.Errors[TcHmi.Errors.E_SERVER_RESPONSE_MISSING],reason:"Missing response from server."};for(const chunk of chunks.values())chunk.file.progressCallback({error:details.code,details:details}),this.__current===chunk.file&&(this.__current=null);return void this.__workQueue()}if(data.response.error){for(const chunk of chunks.values())chunk.file.progressCallback({error:data.response.error.code,details:data.response.error}),this.__current===chunk.file&&(this.__current=null);return void this.__workQueue()}const otherErrors={error:TcHmi.Errors.ERROR,details:{code:TcHmi.Errors.ERROR,message:TcHmi.Errors[TcHmi.Errors.ERROR],errors:[]}};if(data.response.commands&&data.response.commands.length===chunks.size||otherErrors.details.errors.push({code:TcHmi.Errors.E_SERVER_COMMANDS_MISSING,message:TcHmi.Errors[TcHmi.Errors.E_SERVER_COMMANDS_MISSING],reason:`Missing commands in response from server with id: '${data.response.id}'.`}),data.response.commands)for(const command of data.response.commands){if(!command.writeValue){const details={code:TcHmi.Errors.E_SERVER_WRITEVALUE_MISSING,message:TcHmi.Errors[TcHmi.Errors.E_SERVER_WRITEVALUE_MISSING],reason:`Missing writeValue in response from server with id: '${data.response.id}'.`};otherErrors.details.errors.push(details),command.error&&(details.errors=[command.error]);continue}const chunk=chunks.get(command.writeValue.fileName);chunk&&(command.error?(chunk.file.progressCallback({error:command.error.code,details:command.error}),this.__current===chunk.file&&(this.__current=null)):command.writeValue.chunkType===FileUploader.ChunkType.Error?(chunk.file.progressCallback({error:TcHmi.Errors.ERROR,details:{code:TcHmi.Errors.ERROR,message:TcHmi.Errors[TcHmi.Errors.ERROR],reason:`Chunking error while uploading file ${command.writeValue.fileName}.`}}),this.__current===chunk.file&&(this.__current=null)):chunk.file.progressCallback({error:TcHmi.Errors.NONE,uploadedBytes:chunk.file.offset,totalBytes:chunk.file.file.size,status:command.writeValue.chunkType===FileUploader.ChunkType.Last||command.writeValue.chunkType===FileUploader.ChunkType.Disabled?FileUploader.FileStatus.Finished:FileUploader.FileStatus.Uploading}),chunks.delete(command.writeValue.fileName))}if(otherErrors.details.errors.length>0)for(const chunk of chunks.values())chunk.file.progressCallback(otherErrors),this.__current===chunk.file&&(this.__current=null);this.__workQueue()}))}static __subscribeChunkSize(){this.__subscribedToChunkSize=!0,TcHmi.Server.subscribeEx([{symbol:"TcHmiSrv.Config::CHUNKSIZE",commandOptions:["SendWriteValue","SendErrorMessage"]}],TcHmi.Config.get().tcHmiServer.websocketIntervalTime,null,(data=>{if(data.error!==TcHmi.Errors.NONE)return TCHMI_CONSOLE_LOG_LEVEL>=1&&TcHmi.Log.errorEx("[Source=Control, Module=FileUploader, Symbol=TcHmiSrv.Config::CHUNKSIZE] "+TcHmi.Log.buildMessage(data.details)),this.__chunkSizeSubscriptionError={error:data.error,details:data.details},void this.__workQueue();if(!data.response){const details={code:TcHmi.Errors.E_SERVER_RESPONSE_MISSING,message:TcHmi.Errors[TcHmi.Errors.E_SERVER_RESPONSE_MISSING],reason:"Missing response from server."};return TCHMI_CONSOLE_LOG_LEVEL>=1&&TcHmi.Log.errorEx("[Source=Control, Module=FileUploader, Symbol=TcHmiSrv.Config::CHUNKSIZE] "+TcHmi.Log.buildMessage(details)),this.__chunkSizeSubscriptionError={error:details.code,details:details},void this.__workQueue()}if(data.response.error)return TCHMI_CONSOLE_LOG_LEVEL>=1&&TcHmi.Log.errorEx("[Source=Control, Module=FileUploader, Symbol=TcHmiSrv.Config::CHUNKSIZE] "+TcHmi.Log.buildMessage(data.response.error)),this.__chunkSizeSubscriptionError={error:data.response.error.code,details:data.response.error},void this.__workQueue();if(!data.response.commands||!data.response.commands[0]){const details={code:TcHmi.Errors.E_SERVER_COMMANDS_MISSING,message:TcHmi.Errors[TcHmi.Errors.E_SERVER_COMMANDS_MISSING],reason:`Missing commands in response from server with id: '${data.response.id}'.`};return TCHMI_CONSOLE_LOG_LEVEL>=1&&TcHmi.Log.errorEx("[Source=Control, Module=FileUploader, Symbol=TcHmiSrv.Config::CHUNKSIZE] "+TcHmi.Log.buildMessage(details)),this.__chunkSizeSubscriptionError={error:details.code,details:details},void this.__workQueue()}if(data.response.commands[0].error)return TCHMI_CONSOLE_LOG_LEVEL>=1&&TcHmi.Log.errorEx("[Source=Control, Module=FileUploader, Symbol=TcHmiSrv.Config::CHUNKSIZE] "+TcHmi.Log.buildMessage(data.response.commands[0].error)),this.__chunkSizeSubscriptionError={error:data.response.commands[0].error.code,details:data.response.commands[0].error},void this.__workQueue();const readValue=data.response.commands[0].readValue;if(void 0===readValue){const details={code:TcHmi.Errors.E_SERVER_READVALUE_MISSING,message:TcHmi.Errors[TcHmi.Errors.E_SERVER_READVALUE_MISSING],reason:`Missing readValue in response from server with id: '${data.response.id}'.`};TCHMI_CONSOLE_LOG_LEVEL>=1&&TcHmi.Log.errorEx("[Source=Control, Module=FileUploader, Symbol=TcHmiSrv.Config::CHUNKSIZE] "+TcHmi.Log.buildMessage(details)),this.__chunkSizeSubscriptionError={error:details.code,details:details}}else this.__chunkSize=readValue;this.__workQueue()}))}}FileUploader.__queue=[],FileUploader.__current=null,FileUploader.__working=!1,FileUploader.__chunkSize=null,FileUploader.__subscribedToChunkSize=!1,FileUploader.__chunkSizeSubscriptionError=null,TcHmiFileExplorerComponents.FileUploader=FileUploader,function(FileUploader){let FileStatus,ChunkType;!function(FileStatus){FileStatus[FileStatus.Pending=0]="Pending",FileStatus[FileStatus.Uploading=1]="Uploading",FileStatus[FileStatus.Finished=2]="Finished",FileStatus[FileStatus.Canceled=3]="Canceled"}(FileStatus=FileUploader.FileStatus||(FileUploader.FileStatus={})),function(ChunkType){ChunkType[ChunkType.Disabled=0]="Disabled",ChunkType[ChunkType.First=1]="First",ChunkType[ChunkType.Intermediate=2]="Intermediate",ChunkType[ChunkType.Last=3]="Last",ChunkType[ChunkType.Error=4]="Error"}(ChunkType=FileUploader.ChunkType||(FileUploader.ChunkType={}))}(FileUploader=TcHmiFileExplorerComponents.FileUploader||(TcHmiFileExplorerComponents.FileUploader={}))}(Beckhoff.TcHmiFileExplorerComponents||(Beckhoff.TcHmiFileExplorerComponents={}))}(Controls.Beckhoff||(Controls.Beckhoff={}))}(TcHmi.Controls||(TcHmi.Controls={}))}(TcHmi||(TcHmi={}));