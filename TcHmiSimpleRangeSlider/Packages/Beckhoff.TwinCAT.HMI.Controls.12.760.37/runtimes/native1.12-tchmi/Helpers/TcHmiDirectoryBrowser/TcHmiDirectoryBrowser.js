var TcHmi;!function(TcHmi){!function(Controls){!function(Helpers){Helpers.Display=class{constructor(__element,__parentControl){this.__element=__element,this.__parentControl=__parentControl,this.__suspended=!0,this.__directory=null,this.__directoryEventDestroyers=[]}suspend(clear){if(!this.__suspended){for(const destroy of this.__directoryEventDestroyers)destroy();this.__directoryEventDestroyers=[],this.__suspended=!0}}resume(){this.__suspended&&(this.__suspended=!1)}setDirectory(directory){for(const destroy of this.__directoryEventDestroyers)destroy();this.__directoryEventDestroyers=[],this.__directory=directory,this.__processDirectory()}}}(Controls.Helpers||(Controls.Helpers={}))}(TcHmi.Controls||(TcHmi.Controls={}))}(TcHmi||(TcHmi={})),function(TcHmi){!function(Controls){!function(Helpers){class DragAndDropDisplay extends Helpers.Display{constructor(element,parentControl){super(element,parentControl),this.__dragAndDropAllowed=!1,this.__draggedElement=null,this.__dropElement=null,this.__onDragAndDropManager=new TcHmi.Controls.Helpers.CallbackManager,this.onDragAndDrop=this.__onDragAndDropManager.getManipulators(),this.__onDragStart=event=>{event.target instanceof HTMLElement&&event.target.dataset.name&&event.dataTransfer&&this.__parentControl.getIsEnabled()&&TcHmi.Access.checkAccess(this.__parentControl,"operate")&&(event.dataTransfer.setData("text/plain",event.target.dataset.name),this.__draggedElement=event.target,this.__draggedElement.classList.add("dragging"))},this.__onDragOver=event=>{this.__draggedElement&&event.target instanceof HTMLElement&&event.dataTransfer&&this.__parentControl.getIsEnabled()&&TcHmi.Access.checkAccess(this.__parentControl,"operate")&&(event.target!==this.__draggedElement&&event.target.classList.contains("folder")?(event.dataTransfer.dropEffect="move",event.preventDefault(),this.__dropElement&&this.__dropElement.classList.remove("drop-zone"),this.__dropElement=event.target,this.__dropElement.classList.add("drop-zone")):this.__dropElement&&(this.__dropElement.classList.remove("drop-zone"),this.__dropElement=null))},this.__onDrop=event=>{if(!this.__draggedElement)return;if(!(event.target instanceof HTMLElement))return;if(!event.dataTransfer)return;if(!this.__parentControl.getIsEnabled()||!TcHmi.Access.checkAccess(this.__parentControl,"operate"))return;let name=event.dataTransfer.getData("text/plain");if(!name||!this.__element.querySelector(`[data-name="${name}"]`))return;let dropName=event.target.dataset.name;dropName&&(this.__onDragAndDropManager.trigger([name],{name:dropName,isParent:"true"===event.target.dataset.isParent}),this.__draggedElement.classList.remove("dragging"),this.__draggedElement=null,this.__dropElement?.classList.remove("drop-zone"),this.__dropElement=null,event.preventDefault())},this.__onDragEnd=event=>{this.__draggedElement&&(this.__draggedElement.classList.remove("dragging"),this.__draggedElement=null),this.__dropElement&&(this.__dropElement.classList.remove("drop-zone"),this.__dropElement=null)}}suspend(clear=!1){super.suspend(clear),this.__dragAndDropAllowed&&this.__removeDragAndDropHandlers()}resume(){this.__dragAndDropAllowed&&this.__addDragAndDropHandlers()}setDragAndDropAllowed(valueNew){this.__dragAndDropAllowed!==valueNew&&(this.__dragAndDropAllowed=valueNew,this.__processDragAndDropAllowed())}getDragAndDropAllowed(){return this.__dragAndDropAllowed}__processDragAndDropAllowed(){this.__dragAndDropAllowed?this.__addDragAndDropHandlers():this.__removeDragAndDropHandlers()}__addDragAndDropHandlers(){this.__element.addEventListener("dragstart",this.__onDragStart),this.__element.addEventListener("dragover",this.__onDragOver),this.__element.addEventListener("drop",this.__onDrop),this.__element.addEventListener("dragend",this.__onDragEnd)}__removeDragAndDropHandlers(){this.__element.removeEventListener("dragstart",this.__onDragStart),this.__element.removeEventListener("dragover",this.__onDragOver),this.__element.removeEventListener("drop",this.__onDrop),this.__element.removeEventListener("dragend",this.__onDragEnd)}}Helpers.DragAndDropDisplay=DragAndDropDisplay}(Controls.Helpers||(Controls.Helpers={}))}(TcHmi.Controls||(TcHmi.Controls={}))}(TcHmi||(TcHmi={})),function(TcHmi){!function(Controls){!function(Helpers){class PathDisplay extends Helpers.Display{constructor(element,parentControl){super(element,parentControl),this.__mouseDragScrolling=!1,this.__onClick=event=>{if(!this.__directory)return;if(!(event.target instanceof Element))return;if(!this.__parentControl.getIsEnabled()||!TcHmi.Access.checkAccess(this.__parentControl,"operate"))return;let target=event.target.closest("li");if(!target||!this.__itemListElement.contains(target))return;let path=target.dataset.path;this.__directory.setPathAndValidate(path?path.split("::"):[])},this.__onMouseDown=event=>{this.__directory&&event.target instanceof Element&&this.__parentControl.getIsEnabled()&&TcHmi.Access.checkAccess(this.__parentControl,"observe")&&(this.__mouseDragScrolling=!0)},this.__onMouseUp=event=>{this.__mouseDragScrolling=!1},this.__onMouseMove=event=>{this.__mouseDragScrolling&&(this.__scrollContainer.scrollLeft-=event.movementX)},this.__element.classList.add("TcHmi_Controls_Helpers_DirectoryBrowser-path-display"),this.__scrollContainer=document.createElement("div"),this.__scrollContainer.classList.add("TcHmi_Controls_Helpers_DirectoryBrowser-path-display-scroll-container"),this.__itemListElement=document.createElement("ul"),this.__itemListElement.classList.add("TcHmi_Controls_Helpers_DirectoryBrowser-path-display-item-list"),this.__scrollContainer.appendChild(this.__itemListElement),this.__element.appendChild(this.__scrollContainer)}suspend(clear=!1){this.__suspended||(super.suspend(clear),this.__itemListElement.removeEventListener("click",this.__onClick),this.__element.removeEventListener("mousedown",this.__onMouseDown),document.removeEventListener("mouseup",this.__onMouseUp),document.removeEventListener("mousemove",this.__onMouseMove),clear&&this.__updatePath(null))}resume(){this.__suspended&&(super.resume(),this.__itemListElement.addEventListener("click",this.__onClick),this.__element.addEventListener("mousedown",this.__onMouseDown),document.addEventListener("mouseup",this.__onMouseUp),document.addEventListener("mousemove",this.__onMouseMove),this.__processDirectory())}__processDirectory(){this.__directory&&this.__directory.onPathChange.add((()=>this.__updatePath(this.__directory?.decoratedPath))),this.__updatePath(this.__directory?.decoratedPath)}__updatePath(path){if(!path){for(;this.__itemListElement.firstChild;)this.__itemListElement.firstChild.remove();return}let fragment=document.createDocumentFragment(),currentElement=this.__itemListElement.firstElementChild;for(const item of path)currentElement instanceof HTMLLIElement?this.__createOrUpdateListElement(item,currentElement):(currentElement=this.__createOrUpdateListElement(item),fragment.appendChild(currentElement)),currentElement=currentElement.nextElementSibling;for(;currentElement;){let toRemove=currentElement;currentElement=currentElement.nextElementSibling,toRemove.remove()}fragment.childElementCount>0&&this.__itemListElement.appendChild(fragment)}__createOrUpdateListElement(item,element){let li,a;li=element instanceof HTMLElement?element:document.createElement("li"),li.firstElementChild?a=li.firstElementChild:(a=document.createElement("a"),li.appendChild(a));const displayName=item.type!==Helpers.DirectoryBrowser.ItemType.Root?item.name:"/";a.textContent!==displayName&&(a.textContent=displayName);let className=item.type===Helpers.DirectoryBrowser.ItemType.File?"file":"folder";li.className!==className&&(li.className=className);for(const key in li.dataset)delete li.dataset[key];if(item.metadata)for(const key in item.metadata){const type=typeof item.metadata[key];if("string"===type||"number"===type||"boolean"===type)try{li.dataset["metadata"+key.slice(0,1).toUpperCase()+key.slice(1)]=item.metadata[key]}catch(e){TCHMI_CONSOLE_LOG_LEVEL>=1&&TcHmi.Log.errorEx(`[Source=Control, Module=TcHmi.Controls.Helpers.DirectoryBrowser, ControlId=${this.__parentControl.getId()}] The metadata property "${key}" contains characters that cannot be used in a data-attribute. Please use only letters, numbers, periods, colons and underscores in metadata property names.`)}}let path=[];for(;item.type!==Helpers.DirectoryBrowser.ItemType.Root;)path.unshift(item.name),item=item.parent;return li.dataset.path=path.join("::"),li}}Helpers.PathDisplay=PathDisplay}(Controls.Helpers||(Controls.Helpers={}))}(TcHmi.Controls||(TcHmi.Controls={}))}(TcHmi||(TcHmi={})),function(TcHmi){!function(Controls){!function(Helpers){class ListBrowsingDisplay extends Helpers.Display{constructor(element,parentControl){super(element,parentControl),this.__showingParent=!1,this.__lastPointerDown={type:"",timestamp:0,doubleClickOnNextUp:!1,ignoreNextUp:!1,target:null,timeoutID:0,coords:{x:0,y:0}},this.__pointerMultiselect=!1,this.__formatMetadata=null,this.__onPointerDown=event=>{clearTimeout(this.__lastPointerDown.timeoutID),this.__lastPointerDown.timeoutID=0,this.__lastPointerDown.ignoreNextUp=!1,this.__lastPointerDown.coords.x=event.clientX,this.__lastPointerDown.coords.y=event.clientY;const eventInfo=this.__preprocessPointerEvent(event);if(!eventInfo)return this.__lastPointerDown.target=event.target,void(this.__lastPointerDown.doubleClickOnNextUp=!1);const now=(new Date).getTime();this.__lastPointerDown.type===event.pointerType&&this.__lastPointerDown.target===eventInfo.target&&now-this.__lastPointerDown.timestamp<=500&&(this.__lastPointerDown.doubleClickOnNextUp=!0),this.__lastPointerDown.type=event.pointerType,this.__lastPointerDown.timestamp=now,this.__lastPointerDown.target=eventInfo.target,this.__lastPointerDown.timeoutID=setTimeout((()=>{this.__lastPointerDown.timeoutID=0,this.__lastPointerDown.doubleClickOnNextUp=!1,this.__lastPointerDown.ignoreNextUp=!0,this.__pointerMultiselect=!0,this.__select(eventInfo)}),500)},this.__onPointerUp=event=>{if(clearTimeout(this.__lastPointerDown.timeoutID),this.__lastPointerDown.timeoutID=0,this.__lastPointerDown.ignoreNextUp)return void(this.__lastPointerDown.ignoreNextUp=!1);if(this.__lastPointerDown.type!==event.pointerType)return;const eventInfo=this.__preprocessPointerEvent(event);if(!eventInfo)return this.__lastPointerDown.target===event.target&&(this.__select(null),this.__pointerMultiselect=!1),this.__lastPointerDown.target=null,void(this.__lastPointerDown.doubleClickOnNextUp=!1);this.__lastPointerDown.target===eventInfo.target&&(this.__lastPointerDown.doubleClickOnNextUp?(this.__navigate(eventInfo),this.__lastPointerDown.doubleClickOnNextUp=!1,this.__lastPointerDown.timestamp=0):this.__select(eventInfo))},this.__onPointerMove=event=>{if(0===this.__lastPointerDown.timeoutID)return;const deltaX=this.__lastPointerDown.coords.x-event.clientX,deltaY=this.__lastPointerDown.coords.y-event.clientY;deltaX*deltaX+deltaY*deltaY>225&&(clearTimeout(this.__lastPointerDown.timeoutID),this.__lastPointerDown.timeoutID=0)},this.__onScroll=()=>{clearTimeout(this.__lastPointerDown.timeoutID),this.__lastPointerDown.timeoutID=0},this.__onContextMenu=event=>{this.__pointerMultiselect&&event.preventDefault()},this.__element.classList.add("TcHmi_Controls_Helpers_DirectoryBrowser-browsing-display")}__preprocessPointerEvent(event){if(!this.__directory)return!1;if(!(event.target instanceof Element))return!1;if("mouse"===event.pointerType&&0!==event.button)return!1;if(!this.__parentControl.getIsEnabled()||!TcHmi.Access.checkAccess(this.__parentControl,"operate"))return!1;const target=event.target.closest("li");if(!target||!this.__element.contains(target))return!1;const name=target.dataset.name,isParent="true"===target.dataset.isParent;return!(!isParent&&!name)&&{target:target,item:isParent?{isParent:!0}:{isParent:!1,name:name},multiselect:event.ctrlKey||this.__pointerMultiselect}}async __select(event){this.__directory&&(event?event.item.isParent||(event.multiselect&&this.__directory.selectedItemNames.has(event.item.name)?(await this.__directory.deselectItem(event.item.name),0===this.__directory.selectedItemNames.size&&(this.__pointerMultiselect=!1)):this.__directory.selectItem(event.item.name,event.multiselect)):this.__directory.clearSelection())}__navigate(event){if(this.__directory)if(this.__showingParent){const path=tchmi_clone_object(this.__directory.path);path.pop(),event.item.isParent?path.pop():path.push(event.item.name),this.__directory.setPathAndValidate(path)}else event.item.isParent?this.__directory.popPath():this.__directory.pushPath(event.item.name)}suspend(clear=!1){this.__suspended||(super.suspend(clear),document.removeEventListener("pointerdown",this.__onPointerDown),document.removeEventListener("pointermove",this.__onPointerMove),document.removeEventListener("scroll",this.__onScroll),this.__element.removeEventListener("pointerup",this.__onPointerUp),this.__element.removeEventListener("contextmenu",this.__onContextMenu),this.__element.removeEventListener("scroll",this.__onScroll),clear&&this.__updateCurrentItem(null))}resume(){this.__suspended&&(super.resume(),document.addEventListener("pointerdown",this.__onPointerDown),document.addEventListener("pointermove",this.__onPointerMove),document.addEventListener("scroll",this.__onScroll),this.__element.addEventListener("pointerup",this.__onPointerUp),this.__element.addEventListener("contextmenu",this.__onContextMenu),this.__element.addEventListener("scroll",this.__onScroll),this.__processDirectory())}showMetadata(metadataFormatter){this.__formatMetadata=metadataFormatter,this.__updateCurrentItem(this.__directory?.currentItem)}hideMetadata(){this.__formatMetadata=null,this.__updateCurrentItem(this.__directory?.currentItem)}__processDirectory(){this.__directory&&(this.__directory.onPathChange.add((currentItem=>this.__updateCurrentItem(currentItem))),this.__directory.onCurrentItemUpdate.add((currentItem=>this.__updateCurrentItem(currentItem))),this.__directory.onSelectionChange.add((()=>this.__updateSelection()))),this.__updateCurrentItem(this.__directory?.currentItem)}__updateCurrentItem(currentItem){if(!currentItem||!this.__directory){for(;this.__element.firstChild;)this.__element.firstChild.remove();return}let currentFolder=currentItem;currentFolder.type===Helpers.DirectoryBrowser.ItemType.File?(currentFolder=currentFolder.parent,this.__showingParent=!0):this.__showingParent=!1;let directoryItems=Array.from(currentFolder.children.values()).sort(((a,b)=>{if(a.type!==b.type)return a.type===Helpers.DirectoryBrowser.ItemType.File?1:-1;let aName=a.name.toLowerCase(),bName=b.name.toLowerCase();return aName<bName?-1:bName<aName?1:0})),fragment=document.createDocumentFragment(),currentElement=this.__element.firstElementChild;currentFolder.type===Helpers.DirectoryBrowser.ItemType.Folder&&(currentElement instanceof HTMLLIElement?this.__createOrUpdateListElement(currentFolder.parent,ListBrowsingDisplay.ListItemStatus.Parent,currentElement):(currentElement=this.__createOrUpdateListElement(currentFolder.parent,ListBrowsingDisplay.ListItemStatus.Parent),fragment.appendChild(currentElement)),currentElement=currentElement.nextElementSibling);for(const item of directoryItems){let status=ListBrowsingDisplay.ListItemStatus.Default;this.__directory.selectedItemNames.has(item.name)?status=ListBrowsingDisplay.ListItemStatus.Selected:item===currentItem&&(status=ListBrowsingDisplay.ListItemStatus.Current),currentElement instanceof HTMLLIElement?this.__createOrUpdateListElement(item,status,currentElement):(currentElement=this.__createOrUpdateListElement(item,status),fragment.appendChild(currentElement)),currentElement=currentElement.nextElementSibling}for(;currentElement;){let toRemove=currentElement;currentElement=currentElement.nextElementSibling,toRemove.remove()}fragment.childElementCount>0&&this.__element.appendChild(fragment)}__createOrUpdateListElement(item,status=ListBrowsingDisplay.ListItemStatus.Default,element){let li;li=element||document.createElement("li");let displayName=status!==ListBrowsingDisplay.ListItemStatus.Parent&&item.type!==Helpers.DirectoryBrowser.ItemType.Root?item.name:"..";li.textContent!==displayName&&(li.textContent=displayName);let className=item.type===Helpers.DirectoryBrowser.ItemType.File?"file":"folder";li.className!==className&&(li.className=className);for(const key in li.dataset)delete li.dataset[key];switch(status){case ListBrowsingDisplay.ListItemStatus.Selected:li.classList.add("selected");break;case ListBrowsingDisplay.ListItemStatus.Current:li.classList.add("current");break;case ListBrowsingDisplay.ListItemStatus.Parent:li.dataset.isParent="true"}if(status!==ListBrowsingDisplay.ListItemStatus.Parent&&item.type!==Helpers.DirectoryBrowser.ItemType.Root&&(li.dataset.name=item.name),item.metadata)for(const key in item.metadata){const type=typeof item.metadata[key];if("string"===type||"number"===type||"boolean"===type)try{li.dataset["metadata"+key.slice(0,1).toUpperCase()+key.slice(1)]=item.metadata[key]}catch(e){TCHMI_CONSOLE_LOG_LEVEL>=1&&TcHmi.Log.errorEx(`[Source=Control, Module=TcHmi.Controls.Helpers.DirectoryBrowser, ControlId=${this.__parentControl.getId()}] The metadata property "${key}" contains characters that cannot be used in a data-attribute. Please use only letters, numbers, periods, colons and underscores in metadata property names.`)}}let metadataDisplay=li.querySelector("span");return status!==ListBrowsingDisplay.ListItemStatus.Parent&&this.__formatMetadata?(metadataDisplay||(metadataDisplay=li.appendChild(document.createElement("span"))),metadataDisplay.textContent=this.__formatMetadata(item)):metadataDisplay&&metadataDisplay.remove(),li}__updateSelection(){if(this.__directory)for(const child of this.__element.children){if(!(child instanceof HTMLLIElement))continue;const name=child.dataset.name;name&&child.classList.toggle("selected",this.__directory.selectedItemNames.has(name))}}}Helpers.ListBrowsingDisplay=ListBrowsingDisplay,function(ListBrowsingDisplay){let ListItemStatus;!function(ListItemStatus){ListItemStatus[ListItemStatus.Default=0]="Default",ListItemStatus[ListItemStatus.Selected=1]="Selected",ListItemStatus[ListItemStatus.Current=2]="Current",ListItemStatus[ListItemStatus.Parent=3]="Parent"}(ListItemStatus=ListBrowsingDisplay.ListItemStatus||(ListBrowsingDisplay.ListItemStatus={}))}(ListBrowsingDisplay=Helpers.ListBrowsingDisplay||(Helpers.ListBrowsingDisplay={}))}(Controls.Helpers||(Controls.Helpers={}))}(TcHmi.Controls||(TcHmi.Controls={}))}(TcHmi||(TcHmi={})),function(TcHmi){!function(Controls){!function(Helpers){class DirectoryBrowser{constructor(displays){this.__directory=null,this.__suspended=!0,this.__directoryUpdatesSuspension={suspended:!1,cachedUpdate:void 0},this.__fakeFile=null,this.__pathToSet=null,this.__itemsToSelect=[],this.__navigationToFilesAllowedCache=!0,this.__multiSelectAllowedCache=!1,this.__onBeforePathChangeManager=new Helpers.AsyncCallbackManager,this.onBeforePathChange=this.__onBeforePathChangeManager.getManipulators(),this.__onBeforeSelectionChangeManager=new Helpers.AsyncCallbackManager,this.onBeforeSelectionChange=this.__onBeforeSelectionChangeManager.getManipulators(),this.__onSelectionChangeManager=new Helpers.CallbackManager,this.onSelectionChange=this.__onSelectionChangeManager.getManipulators(),this.__onSelectedItemUpdateManager=new Helpers.CallbackManager,this.onSelectedItemUpdate=this.__onSelectedItemUpdateManager.getManipulators(),this.__onPathChangeManager=new Helpers.CallbackManager,this.onPathChange=this.__onPathChangeManager.getManipulators(),this.__onCurrentItemUpdateManager=new Helpers.CallbackManager,this.onCurrentItemUpdate=this.__onCurrentItemUpdateManager.getManipulators(),this.__onBeforePathChange=async(newCurrentItem,path,cancelable)=>{if(!this.__directory)return!1;return(await this.__onBeforePathChangeManager.trigger(newCurrentItem,tchmi_clone_object(path),cancelable)).every((result=>"rejected"===result.status||result.value))},this.__onBeforeSelectionChange=async(newSelectedItems,cancelable)=>{if(!this.__directory)return!1;return(await this.__onBeforeSelectionChangeManager.trigger(newSelectedItems,cancelable)).every((result=>"rejected"===result.status||result.value))},this.__onSelectionChange=newSelectedItems=>{this.__directory&&this.__onSelectionChangeManager.trigger(newSelectedItems)},this.__onSelectedItemUpdate=selectedItem=>{this.__directory&&this.__onSelectedItemUpdateManager.trigger(selectedItem)},this.__onPathChange=(currentItem,path)=>{this.__directory&&this.__onPathChangeManager.trigger(currentItem,tchmi_clone_object(path))},this.__onCurrentItemChange=currentItem=>{this.__directory&&this.__onCurrentItemUpdateManager.trigger(currentItem)},this.__displays=new Set(displays)}addDisplay(display){this.__displays.add(display),display.setDirectory(this.__directory)}removeDisplay(display){this.__displays.delete(display)&&display.suspend(!0)}suspend(clear=!1){if(!this.__suspended){for(const display of this.__displays)display.suspend(clear);this.__directory=null,this.__suspended=!0}}resume(){if(this.__suspended){this.__suspended=!1;for(const display of this.__displays)display.resume()}}suspendDirectoryUpdates(){this.__directoryUpdatesSuspension.suspended||(this.__directoryUpdatesSuspension.suspended=!0)}resumeDirectoryUpdates(){this.__directoryUpdatesSuspension.suspended&&(this.__directoryUpdatesSuspension.suspended=!1,void 0!==this.__directoryUpdatesSuspension.cachedUpdate&&(this.__updateDirectory(this.__directoryUpdatesSuspension.cachedUpdate),this.__directoryUpdatesSuspension.cachedUpdate=void 0))}getCurrentItem(){return this.__directory?this.__directory.currentItem:null}getCurrentFolder(){return this.__directory?this.__directory.currentFolder:null}getPath(){return this.__directory?tchmi_clone_object(this.__directory.path):null}getFolderPath(){return this.__directory?this.__directory.currentItem.type===DirectoryBrowser.ItemType.Folder?tchmi_clone_object(this.__directory.path):this.__directory.path.slice(0,-1):null}getSelectedItems(){return this.__directory?this.__directory.selectedItems:null}setPath(value){return this.__pathToSet&&(this.__pathToSet.callback(!1),this.__pathToSet=null),this.__directory?this.__directory.setPathAndValidate(tchmi_clone_object(value)):new Promise((resolve=>{this.__pathToSet={path:tchmi_clone_object(value),callback:resolve}}))}selectItem(name,expandSelection){if(!expandSelection){for(const itemToSelect of this.__itemsToSelect)itemToSelect.callback(!1);this.__itemsToSelect=[]}return this.__directory?this.__directory.selectItem(name,expandSelection):new Promise((resolve=>{this.__itemsToSelect.push({itemName:name,callback:resolve})}))}deselectItem(name){if(this.__directory)return this.__directory.deselectItem(name);const index=this.__itemsToSelect.findIndex((itemToSelect=>itemToSelect.itemName===name));return-1!==index?(this.__itemsToSelect[index].callback(!1),this.__itemsToSelect.splice(index,1),Promise.resolve(!0)):Promise.resolve(!1)}clearSelection(){if(this.__directory)return this.__directory.clearSelection();for(const item of this.__itemsToSelect)item.callback(!1);return this.__itemsToSelect=[],Promise.resolve(!0)}fakeFile(path,payload,metadata){this.__fakeFile&&tchmi_equal(this.__fakeFile.path,path)&&tchmi_equal(this.__fakeFile.payload,payload)&&tchmi_equal(this.__fakeFile.metadata,metadata)||(this.__fakeFile={path:path,payload:payload,metadata:metadata,remove:()=>this.__directory?.root??null},this.__updateDirectory(this.__directory?.root??null))}clearFakedFile(){if(!this.__fakeFile)return;const unfaked=this.__fakeFile.remove();this.__fakeFile=null,this.__updateDirectory(unfaked)}hasFakedFile(){return null!==this.__fakeFile}setNavigationToFilesAllowed(value){this.__directory&&(this.__directory.navigationToFilesAllowed=value),this.__navigationToFilesAllowedCache=value}getNavigationToFilesAllowed(){return this.__directory?.navigationToFilesAllowed??this.__navigationToFilesAllowedCache}setMultiSelectAllowed(value){this.__directory&&(this.__directory.multiSelectAllowed=value),this.__multiSelectAllowedCache=value}getMultiSelectAllowed(){return this.__directory?.multiSelectAllowed??this.__multiSelectAllowedCache}setDirectory(rootFolder,getChildren,isFile,getMetadata){const directory=null===rootFolder?null:this.buildDirectoryTree(rootFolder,getChildren,isFile,getMetadata);return this.__updateDirectory(directory)}async __updateDirectory(directory){if(this.__directoryUpdatesSuspension.suspended)this.__directoryUpdatesSuspension.cachedUpdate=directory;else{if(this.__fakeFile&&this.__fakeFile.path.length>0){let removeFunction=null;directory||(directory={type:DirectoryBrowser.ItemType.Root,payload:void 0,children:new Map},removeFunction=()=>null);let current=directory,abort=!1;for(const name of this.__fakeFile.path.slice(0,-1)){let next=current.children.get(name);if(next||(next={type:DirectoryBrowser.ItemType.Folder,name:name,payload:void 0,parent:current,children:new Map},current.children.set(name,next),removeFunction||(removeFunction=()=>(next.parent.children.delete(name),directory))),next.type===DirectoryBrowser.ItemType.File){abort=!0;break}current=next}let filename=this.__fakeFile.path[this.__fakeFile.path.length-1];abort||current.children.has(filename)||(current.children.set(filename,{type:DirectoryBrowser.ItemType.File,name:filename,parent:current,payload:this.__fakeFile.payload,metadata:this.__fakeFile.metadata}),removeFunction||(removeFunction=()=>(current.children.delete(filename),directory)),this.__fakeFile.remove=removeFunction)}if(directory)if(this.__directory)await this.__directory.setRootAndValidate(directory);else{this.__directory=new DirectoryBrowser.Directory(directory),this.__directory.navigationToFilesAllowed=this.__navigationToFilesAllowedCache,this.__directory.multiSelectAllowed=this.__multiSelectAllowedCache;for(const display of this.__displays)display.setDirectory(this.__directory);this.__directory.onBeforePathChange.add(this.__onBeforePathChange),this.__directory.onBeforeSelectionChange.add(this.__onBeforeSelectionChange),this.__directory.onSelectionChange.add(this.__onSelectionChange),this.__directory.onSelectedItemUpdate.add(this.__onSelectedItemUpdate),this.__directory.onPathChange.add(this.__onPathChange),this.__directory.onCurrentItemUpdate.add(this.__onCurrentItemChange),this.__pathToSet&&(this.__pathToSet.callback(this.__directory.setPathAndValidate(this.__pathToSet.path)),this.__pathToSet=null);for(const itemToSelect of this.__itemsToSelect)itemToSelect.callback(this.__directory.selectItem(itemToSelect.itemName,!0));this.__itemsToSelect=[]}else if(this.__directory){await this.__onBeforePathChangeManager.trigger(null,null,!1),await this.__onBeforeSelectionChangeManager.trigger(null,!1),this.__directory.onBeforePathChange.remove(this.__onBeforePathChange),this.__directory.onBeforeSelectionChange.remove(this.__onBeforeSelectionChange),this.__directory.onSelectionChange.remove(this.__onSelectionChange),this.__directory.onSelectedItemUpdate.remove(this.__onSelectedItemUpdate),this.__directory.onPathChange.remove(this.__onPathChange),this.__directory.onCurrentItemUpdate.remove(this.__onCurrentItemChange),this.__directory=null,this.__onSelectionChangeManager.trigger(null),this.__onPathChangeManager.trigger(null,null);for(const display of this.__displays)display.setDirectory(null)}}}buildDirectoryTree(rootFolder,getChildren,isFile,getMetadata){let buildTree=root=>{for(const[name,childPayload]of getChildren(root.payload))if(isFile(childPayload)){const child={type:DirectoryBrowser.ItemType.File,name:name,payload:childPayload,parent:root};getMetadata&&(child.metadata=getMetadata(childPayload)),root.children.set(name,child)}else{const child={type:DirectoryBrowser.ItemType.Folder,name:name,payload:childPayload,parent:root,children:new Map};getMetadata&&(child.metadata=getMetadata(childPayload)),buildTree(child),root.children.set(name,child)}};const root={type:DirectoryBrowser.ItemType.Root,payload:rootFolder,children:new Map};return buildTree(root),root}}Helpers.DirectoryBrowser=DirectoryBrowser,function(DirectoryBrowser){let ItemType;!function(ItemType){ItemType[ItemType.File=0]="File",ItemType[ItemType.Folder=1]="Folder",ItemType[ItemType.Root=2]="Root"}(ItemType=DirectoryBrowser.ItemType||(DirectoryBrowser.ItemType={}));DirectoryBrowser.Directory=class{constructor(__root){this.__root=__root,this.__path=[],this.__selectedItemNames=new Set,this.__navigationToFilesAllowed=!0,this.__multiSelectAllowed=!1,this.__onBeforePathChangeManager=new Helpers.AsyncCallbackManager,this.onBeforePathChange=this.__onBeforePathChangeManager.getManipulators(),this.__onBeforeSelectionChangeManager=new Helpers.AsyncCallbackManager,this.onBeforeSelectionChange=this.__onBeforeSelectionChangeManager.getManipulators(),this.__onSelectionChangeManager=new Helpers.CallbackManager,this.onSelectionChange=this.__onSelectionChangeManager.getManipulators(),this.__onSelectedItemUpdateManager=new Helpers.CallbackManager,this.onSelectedItemUpdate=this.__onSelectedItemUpdateManager.getManipulators(),this.__onPathChangeManager=new Helpers.CallbackManager,this.onPathChange=this.__onPathChangeManager.getManipulators(),this.__onCurrentItemUpdateManager=new Helpers.CallbackManager,this.onCurrentItemUpdate=this.__onCurrentItemUpdateManager.getManipulators(),this.__onDirectoryUpdateManager=new Helpers.CallbackManager,this.onDirectoryUpdate=this.__onDirectoryUpdateManager.getManipulators(),this.__currentItem=__root}get root(){return this.__root}async setRootAndValidate(value){let validationResult=this.__validatePath(value,this.__path),selectedItems=[];if(validationResult.isValid){if(validationResult.currentItem.type!==ItemType.File)for(const selectedItemName of this.__selectedItemNames){const oldSelectedItem=this.__currentItem.type!==ItemType.File?this.__currentItem.children.get(selectedItemName):void 0,newSelectedItem=validationResult.currentItem.children.get(selectedItemName);oldSelectedItem&&newSelectedItem&&selectedItems.push({old:oldSelectedItem,new:newSelectedItem})}}else await this.__onBeforePathChangeManager.trigger(validationResult.currentItem,tchmi_clone_object(validationResult.newPath),!1);if(selectedItems.length!==this.__selectedItemNames.size){const oldSelectedItems=selectedItems.map((entry=>entry.old));await this.__onBeforeSelectionChangeManager.trigger(oldSelectedItems,!1),this.__selectedItemNames=new Set(oldSelectedItems.map((item=>item.name))),this.__onSelectionChangeManager.trigger(oldSelectedItems)}const oldCurrentItem=this.currentItem;this.__root=value,this.__currentItem=validationResult.currentItem;for(const item of selectedItems)this.__itemsEquivalent(item.old,item.new)||this.__onSelectedItemUpdateManager.trigger(item.new);return validationResult.isValid?(this.__itemsEquivalent(oldCurrentItem,this.currentItem)||this.__onCurrentItemUpdateManager.trigger(this.__currentItem),this.__onDirectoryUpdateManager.trigger(this.__root),!0):(this.__path=validationResult.newPath,this.__onPathChangeManager.trigger(this.__currentItem,this.__path),this.__onDirectoryUpdateManager.trigger(this.__root),!1)}get path(){return this.__path}get decoratedPath(){let path=[],current=this.__currentItem;for(;current.type!==ItemType.Root;)path.unshift(current),current=current.parent;return path.unshift(current),path}async setPathAndValidate(value,cancelable=!0){if(tchmi_equal(value,this.__path))return!0;let validationResult=this.__validatePath(this.__root,value);if(!validationResult.isValid)return!1;const results=await this.__onBeforePathChangeManager.trigger(validationResult.currentItem,tchmi_clone_object(value),cancelable);if(cancelable&&results.some((result=>"fulfilled"===result.status&&!result.value)))return!1;const clearSelectionResult=await this.clearSelection(cancelable);return!(cancelable&&!clearSelectionResult)&&(this.__path=value,this.__currentItem=validationResult.currentItem,this.__onPathChangeManager.trigger(this.__currentItem,tchmi_clone_object(this.__path)),!0)}async pushPath(name,cancelable=!0){if(this.__currentItem.type===ItemType.File)return!1;let newCurrentItem=this.__currentItem.children.get(name);if(!newCurrentItem||newCurrentItem.type===ItemType.File&&!this.__navigationToFilesAllowed)return!1;const results=await this.__onBeforePathChangeManager.trigger(newCurrentItem,this.__path.concat(name),cancelable);if(cancelable&&results.some((result=>"fulfilled"===result.status&&!result.value)))return!1;const clearSelectionResult=await this.clearSelection(cancelable);return!(cancelable&&!clearSelectionResult)&&(this.__path.push(name),this.__currentItem=newCurrentItem,this.__onPathChangeManager.trigger(this.__currentItem,tchmi_clone_object(this.__path)),!0)}async popPath(cancelable=!0){if(this.__currentItem.type===ItemType.Root)return null;const results=await this.__onBeforePathChangeManager.trigger(this.__currentItem.parent,this.__path.slice(0,-1),cancelable);if(cancelable&&results.some((result=>"fulfilled"===result.status&&!result.value)))return null;const clearSelectionResult=await this.clearSelection(cancelable);if(cancelable&&!clearSelectionResult)return!1;let popped=this.__path.pop();return this.__currentItem=this.__currentItem.parent,this.__onPathChangeManager.trigger(this.__currentItem,tchmi_clone_object(this.__path)),popped??null}get currentItem(){return this.__currentItem}get currentFolder(){return this.__currentItem.type===ItemType.File?this.__currentItem.parent:this.__currentItem}get selectedItemNames(){return this.__selectedItemNames}get selectedItems(){const items=[];if(this.__currentItem.type!==ItemType.File)for(const name of this.__selectedItemNames){const item=this.__currentItem.children.get(name);item&&items.push(item)}return items}async selectItem(name,expandSelection,cancelable=!0){if(this.__selectedItemNames.has(name)&&(expandSelection||1===this.__selectedItemNames.size))return!0;if(this.__currentItem.type===ItemType.File)return!1;const selectedItem=this.__currentItem.children.get(name);if(!selectedItem)return!1;const selectedItems=(expandSelection=expandSelection&&this.__multiSelectAllowed)?this.selectedItems:[];selectedItems.push(selectedItem);const results=await this.__onBeforeSelectionChangeManager.trigger(selectedItems,cancelable);return(!cancelable||!results.some((result=>"fulfilled"===result.status&&!result.value)))&&(expandSelection||this.__selectedItemNames.clear(),this.__selectedItemNames.add(name),this.__onSelectionChangeManager.trigger(selectedItems),!0)}async deselectItem(name,cancelable=!0){if(!this.__selectedItemNames.has(name))return!0;const selectedItems=this.selectedItems.filter((item=>item.name!==name)),results=await this.__onBeforeSelectionChangeManager.trigger(selectedItems,cancelable);return(!cancelable||!results.some((result=>"fulfilled"===result.status&&!result.value)))&&(this.__selectedItemNames.delete(name),this.__onSelectionChangeManager.trigger(selectedItems),!0)}async clearSelection(cancelable=!0){if(0===this.__selectedItemNames.size)return!0;const results=await this.__onBeforeSelectionChangeManager.trigger([],cancelable);return(!cancelable||!results.some((result=>"fulfilled"===result.status&&!result.value)))&&(this.__selectedItemNames.clear(),this.__onSelectionChangeManager.trigger([]),!0)}set navigationToFilesAllowed(value){this.__navigationToFilesAllowed=value,this.__navigationToFilesAllowed||this.currentItem.type!==ItemType.File||this.popPath(!1)}get navigationToFilesAllowed(){return this.__navigationToFilesAllowed}set multiSelectAllowed(value){this.__multiSelectAllowed=value,!this.__multiSelectAllowed&&this.selectedItemNames.size>1&&this.clearSelection()}get multiSelectAllowed(){return this.__navigationToFilesAllowed}__validatePath(root,path){let current=root,valid=!0,index=0;for(;index<path.length;index++){if(current.type===ItemType.File){valid=!1;break}let name=path[index],next=current.children.get(name);if(!next||next.type===ItemType.File&&!this.__navigationToFilesAllowed){valid=!1;break}current=next}if(!valid){return{isValid:!1,newPath:path.slice(0,index),currentItem:current}}return{isValid:!0,currentItem:current}}__itemsEquivalent(a,b){if(a.type!==b.type)return!1;if(a.type!==ItemType.Root&&b.type!==ItemType.Root&&a.name!==b.name)return!1;if(a.type!==ItemType.File&&b.type!==ItemType.File){if(a.children.size!==b.children.size)return!1;const aIterator=a.children.entries(),bIterator=b.children.entries();let aStep=aIterator.next(),bStep=bIterator.next();for(;!aStep.done&&!bStep.done;){if(aStep.value[0]!==bStep.value[0])return!1;if(!this.__itemsEquivalent(aStep.value[1],bStep.value[1]))return!1;aStep=aIterator.next(),bStep=bIterator.next()}}else if(a.payload===b.payload||!tchmi_equal(a.payload,b.payload))return!1;return!(a.metadata===b.metadata||!tchmi_equal(a.metadata,b.metadata))}}}(DirectoryBrowser=Helpers.DirectoryBrowser||(Helpers.DirectoryBrowser={}))}(Controls.Helpers||(Controls.Helpers={}))}(TcHmi.Controls||(TcHmi.Controls={}))}(TcHmi||(TcHmi={}));